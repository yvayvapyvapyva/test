<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Навигация</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=ВАШ_API_КЛЮЧ&lang=ru_RU"></script>

<style>
html, body { margin:0; height:100%; font-family:Arial; }
#map { width:100%; height:100%; }
#start{position:absolute;inset:0;z-index:20;background:black;color:white;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
#togglePanelBtn{position:absolute;top:10px;left:10px;z-index:16;width:36px;height:36px;background:white;border:none;border-radius:6px;font-size:20px}
#panel{position:absolute;top:50px;left:10px;z-index:15;width:300px;max-height:80%;background:rgba(255,255,255,.95);padding:8px;border-radius:6px;display:none;overflow:auto}
#panel input, #panel select{width:100%;margin-top:4px}
#panel label{font-size:13px;font-weight:bold}
#targets div{padding:6px;border-bottom:1px solid #ddd;cursor:pointer}
#targets div.active{background:#c8f7c5;font-weight:bold}
#info{position:absolute;bottom:0;left:0;width:100%;background:rgba(255,255,255,.95);padding:8px;font-weight:bold;z-index:15}
hr{margin:8px 0}
</style>
</head>

<body>

<div id="start">Нажмите для запуска</div>
<button id="togglePanelBtn">☰</button>

<div id="panel">
<button onclick="document.getElementById('jsonFile').click()">Загрузить JSON</button>
<input id="jsonFile" type="file" accept=".json" style="display:none">

<label>Выберите маршрут с Gist</label>
<select id="gistSelect"><option value="">-- Загрузка... --</option></select>

<label>Дистанция триггера (м)</label>
<input id="distanceTrigger" type="number" value="20">

<button id="toggleAutoCenter">Автоцентр: Вкл</button>

<hr>

<label>Усреднение азимута (точек)</label>
<input id="azAvgCount" type="number" value="5" min="1" max="20">

<hr>
<div id="targets"></div>
</div>

<div id="info">Ожидание GPS…</div>
<div id="map"></div>

<script>
/* ==== ПЕРЕМЕННЫЕ ==== */
let map, userPlacemark, points = [], autoCenter = true, wakeLock = null;
let azHistory = [], lastAzimuth = 0, lastSpeed = 0, firstFix = true;

/* ==== Звуки ==== */
const SOUND_MAP = {
"На перекрестке повернем направо":"1.wav",
"Поверните налево":"left.mp3",
"Двигайтесь прямо":"straight.mp3",
"Развернитесь":"uturn.mp3",
"Остановитесь":"stop.mp3"
};
const audio = new Audio(); audio.preload="auto"; let playingNow=false;

function playCommand(text){
    const file=SOUND_MAP[text];
    if(file){
        if(playingNow){audio.pause();audio.currentTime=0;}
        audio.src=file; playingNow=true; audio.play().catch(()=>{});
        audio.onended=()=>playingNow=false;
    }else{
        const u=new SpeechSynthesisUtterance(text);
        u.lang="ru-RU"; speechSynthesis.speak(u);
    }
}

/* ==== DOM ==== */
const start = document.getElementById('start');
const panel = document.getElementById('panel');
const togglePanelBtn = document.getElementById('togglePanelBtn');
const targets = document.getElementById('targets');
const info = document.getElementById('info');
const distanceTrigger = document.getElementById('distanceTrigger');
const toggleAutoCenter = document.getElementById('toggleAutoCenter');
const jsonFile = document.getElementById('jsonFile');
const gistSelect = document.getElementById('gistSelect');
const azAvgCount = document.getElementById('azAvgCount');

/* ==== START ==== */
start.onclick = async () => {
    start.remove();
    speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    if ('wakeLock' in navigator) try{wakeLock=await navigator.wakeLock.request('screen')}catch(e){}
    initMap();
    loadGistFiles();
};
togglePanelBtn.onclick = () => panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
toggleAutoCenter.onclick = () => { autoCenter=!autoCenter; toggleAutoCenter.textContent=`Автоцентр: ${autoCenter?'Вкл':'Выкл'}`; };

/* ==== MAP ==== */
function initMap(){
    ymaps.ready(()=>{
        map = new ymaps.Map("map",{center:[0,0],zoom:18,type:'yandex#satellite',controls:[]});
        userPlacemark = new ymaps.Placemark([0,0],{},{
            iconLayout:'default#image',
            iconImageHref: arrowSVG(0,'red'),
            iconImageSize:[40,40], iconImageOffset:[-20,-20]
        });
        map.geoObjects.add(userPlacemark);
        navigator.geolocation.watchPosition(onGPS, console.error, {enableHighAccuracy:true});
    });
}

/* ==== GPS + AZIMUTH ==== */
function onGPS(p){
    const c=[p.coords.latitude,p.coords.longitude];
    const speedKmh = p.coords.speed!=null?p.coords.speed*3.6:0;
    lastSpeed = speedKmh.toFixed(1);

    if(p.coords.heading!==null && !isNaN(p.coords.heading) && speedKmh>=3){
        azHistory.push(p.coords.heading);
        if(azHistory.length>+azAvgCount.value) azHistory.shift();
    }

    const avgAz = azHistory.length ? averageAngle(azHistory) : lastAzimuth;
    lastAzimuth = avgAz;

    userPlacemark.geometry.setCoordinates(c);
    userPlacemark.options.set('iconImageHref', arrowSVG(avgAz,'red'));

    if(firstFix){map.setCenter(c,18); firstFix=false;}
    if(autoCenter) map.setCenter(c);

    checkDistance(c, avgAz);
    updateInfo();
}

/* ==== CHECK DISTANCE + TRIGGER ==== */
function checkDistance(pos,az){
    if(!points.length){ info.textContent='Маршрут пуст'; return; }
    const p=points[0];
    const dist=Math.round(getDistance(pos[0],pos[1],p.coords[0],p.coords[1]));
    const diff=Math.abs(((Math.round(az)-p.azimuth+540)%360)-180);

    if(dist <= (+distanceTrigger.value||20) && diff <= 45){
        playCommand(p.text);
        map.geoObjects.remove(p.placemark);
        points.shift();
        rebuildRoute();
    }
}

/* ==== UPDATE INFO ==== */
function updateInfo(){
    if(!points.length){ info.textContent='Маршрут пуст'; return; }
    const p=points[0];
    const c = userPlacemark.geometry.getCoordinates();
    const dist=Math.round(getDistance(c[0],c[1],p.coords[0],p.coords[1]));
    info.textContent = `№${p.id} | ${p.text} | Д: ${dist}м | Аз:${Math.round(lastAzimuth)}° | Цель:${p.azimuth}° | Скорость:${lastSpeed} км/ч`;
}

/* ==== JSON / ROUTE ==== */
jsonFile.onchange = e => {
    const r = new FileReader();
    r.onload = () => {
        points = JSON.parse(r.result).map((p,i)=>({
            id:i+1,
            coords:[p.lat,p.lon],
            azimuth:p.azimuth,
            text:p.command,
            color:p.color
        }));
        rebuildRoute();
    };
    r.readAsText(e.target.files[0]);
};

/* ==== DYNAMIC GIST ==== */
async function loadGistFiles(){
    const gistId='7d43c5ede26775934e66792a12fe656d';
    const apiUrl = `https://api.github.com/gists/${gistId}`;
    try{
        const res = await fetch(apiUrl);
        const gist = await res.json();
        gistSelect.innerHTML = '<option value="">-- Выберите маршрут --</option>';
        for(let f in gist.files){
            if(f.toLowerCase().endsWith('.json')){
                const file = gist.files[f];
                const opt = document.createElement('option');
                opt.value = file.raw_url;
                opt.textContent = f.replace(/\.json$/i,'');
                gistSelect.appendChild(opt);
            }
        }
    }catch(e){ gistSelect.innerHTML='<option value="">Ошибка загрузки</option>'; console.error(e);}
}

gistSelect.onchange = async ()=>{
    const url = gistSelect.value;
    if(!url) return;
    try{
        const r = await fetch(url);
        const data = await r.json();
        points = data.map((p,i)=>({id:i+1,coords:[p.lat,p.lon],azimuth:p.azimuth,text:p.command,color:p.color}));
        rebuildRoute();
    }catch(e){ alert('Ошибка загрузки маршрута'); console.error(e);}
};

/* ==== ROUTE ==== */
function rebuildRoute(){
    clearRoute();
    targets.innerHTML = '';
    points.forEach((p,i)=>{
        const color = p.color || 'blue';
        const isActive = i===0;

        p.placemark = new ymaps.Placemark(p.coords, {balloonContent:`<b>Цель №${p.id}</b><br>${p.text}`},{
            iconLayout:'default#image',
            iconImageHref: arrowSVG(p.azimuth,color,p.id,1,isActive),
            iconImageSize:[40,40],
            iconImageOffset:[-20,-20]
        });

        p.placemark.events.add('click',()=>{ p.placemark.balloon.open(); setTimeout(()=>p.placemark.balloon.close(),2000); });
        map.geoObjects.add(p.placemark);

        const d = document.createElement('div');
        d.textContent = `${p.id}. ${p.text}`;
        if(isActive) d.classList.add('active');
        d.onclick = ()=>{ points=points.slice(i); rebuildRoute(); };
        targets.appendChild(d);
    });

    updateInfo();
}

/* ==== CLEAR ==== */
function clearRoute(){
    if(!map) return;
    const objectsToRemove = [];
    map.geoObjects.each(o=>{ if(o!==userPlacemark) objectsToRemove.push(o); });
    objectsToRemove.forEach(o=>map.geoObjects.remove(o));
}

/* ==== UTILS ==== */
function averageAngle(arr){ let x=0,y=0; for(const a of arr){ const r=a*Math.PI/180; x+=Math.cos(r); y+=Math.sin(r); } return (Math.atan2(y,x)*180/Math.PI+360)%360; }
function getDistance(a,b,c,d){ const R=6371000; const dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180; const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); }

function arrowSVG(a,color,num='',opacity=1,highlight=false){
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
<g transform="rotate(${a},20,20)">
<polygon points="20,2 30,32 20,26 10,32" fill="${color}" fill-opacity="${opacity}" stroke="${highlight?'#7CFC00':'black'}" stroke-width="1"/>
</g>
${num?`<text x="20" y="20" font-size="16" fill="white" stroke="black" stroke-width="1" font-family="Arial" text-anchor="middle" dominant-baseline="middle">${num}</text>`:''}
</svg>`);
}
</script>
</body>
</html>
