<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä: iOS Safari Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; position: absolute; }
        
        #start { 
            position: absolute; inset: 0; z-index: 100; 
            background: #007bff; color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; text-align: center; padding: 20px;
        }

        #togglePanelBtn { 
            position: absolute; top: 15px; left: 15px; z-index: 50; 
            width: 44px; height: 44px; background: white; border: none; border-radius: 50%; font-size: 20px;
        }

        #panel { 
            position: absolute; top: 70px; left: 15px; z-index: 40; 
            width: 280px; max-height: 70vh; background: white; 
            padding: 15px; border-radius: 12px; display: none; overflow-y: auto;
        }

        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #888; margin-bottom: 5px; }
        input, button, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; -webkit-appearance: none; }
        button { background: #007bff; color: white; border: none; font-weight: bold; }
        
        #info { 
            position: absolute; bottom: 0; width: 100%; background: white; 
            padding: 15px; z-index: 30; box-sizing: border-box;
        }
        .main-text { font-size: 18px; font-weight: bold; color: #007bff; }
        .stats { display: flex; justify-content: space-between; font-size: 13px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="start">
    <h1 style="margin-bottom:10px">–ù–∞–∂–∞—Ç—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞</h1>
    <p>–≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ –Ω–∞ iPhone</p>
</div>

<button id="togglePanelBtn">‚ò∞</button>

<div id="panel">
    <div class="group">
        <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–º–µ—Ç—Ä—ã)</label>
        <input type="number" id="distanceTrigger" value="20" pattern="[0-9]*">
    </div>
    <div class="group">
        <label>–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞</label>
        <select id="voiceSelect"></select>
    </div>
    <div class="group">
        <button onclick="speak('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–≤—É–∫–∞ –Ω–∞ –∞–π—Ñ–æ–Ω–µ')">–¢–µ—Å—Ç –∑–≤—É–∫–∞</button>
    </div>
    <div class="group">
        <button onclick="document.getElementById('jsonFile').click()" style="background:#6c757d">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
        <input id="jsonFile" type="file" accept=".json" style="display:none">
    </div>
    <div id="targets"></div>
</div>

<div id="info">
    <div class="main-text" id="targetText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    <div class="stats">
        <span id="distText">--- –º</span>
        <span id="speedText">0 –∫–º/—á</span>
        <span id="targetAzText">–ö—É—Ä—Å: ---</span>
    </div>
</div>

<div id="map"></div>

<script>
let map, userPlacemark, points = [], autoCenter = true;
let azHistory = [], lastAzimuth = 0;
let selectedVoice = null;

/* ==== –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ó–í–£–ß–ö–ê –î–õ–Ø iOS (Safari) ==== */

// –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–≥–æ –≥–æ–ª–æ—Å–∞
function initVoices() {
    const voiceSelect = document.getElementById('voiceSelect');
    const voices = window.speechSynthesis.getVoices();
    
    // –í iOS –ª—É—á—à–∏–µ –≥–æ–ª–æ—Å–∞ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è "Milena", "Katya" –∏–ª–∏ –∏–º–µ—é—Ç –ø–æ–º–µ—Ç–∫—É "Premium"
    // –¢–∞–∫–∂–µ –Ω–∞ iPhone –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –≥–æ–ª–æ—Å–∞ Google, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Google
    const ruVoices = voices.filter(v => v.lang.includes('ru'));
    
    voiceSelect.innerHTML = '';
    ruVoices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = v.name;
        if (v.name.includes('Premium') || v.name.includes('Google')) opt.selected = true;
        voiceSelect.appendChild(opt);
    });

    selectedVoice = ruVoices.find(v => v.name.includes('Premium')) || 
                    ruVoices.find(v => v.name.includes('Google')) || 
                    ruVoices[0];
}

window.speechSynthesis.onvoiceschanged = initVoices;

function speak(text) {
    if (!text) return;
    
    // –í–ê–ñ–ù–û –¥–ª—è iOS: –æ—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ–∑–≤—É—á–∫–∏
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    
    // –í—ã–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞
    const voices = window.speechSynthesis.getVoices();
    const voiceName = document.getElementById('voiceSelect').value;
    utter.voice = voices.find(v => v.name === voiceName) || selectedVoice;
    
    utter.lang = 'ru-RU';
    utter.rate = 1.0; 
    utter.pitch = 1.0;
    utter.volume = 1.0;

    window.speechSynthesis.speak(utter);
}

/* ==== GPS –ò –ö–ê–†–¢–ê ==== */
async function startApp() {
    document.getElementById('start').remove();
    
    // –®–ê–ì 1: "–ú–∞–≥–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞" –∑–≤—É–∫–∞ –¥–ª—è iOS
    // –ú—ã –∑–∞–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—É—é –æ–∑–≤—É—á–∫—É –ø—Ä—è–º–æ –≤ –º–æ–º–µ–Ω—Ç –∫–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const unlockUtter = new SpeechSynthesisUtterance('');
    window.speechSynthesis.speak(unlockUtter);
    
    initVoices();
    
    if ('wakeLock' in navigator) {
        try { await navigator.wakeLock.request('screen'); } catch(e){}
    }

    ymaps.ready(() => {
        map = new ymaps.Map("map", {
            center: [0, 0], zoom: 18, type: 'yandex#satellite', controls: []
        });

        userPlacemark = new ymaps.Placemark([0, 0], {}, {
            iconLayout: 'default#image',
            iconImageHref: createArrowSVG(0, '#007bff'),
            iconImageSize: [44, 44], iconImageOffset: [-22, -22]
        });

        map.geoObjects.add(userPlacemark);
        
        navigator.geolocation.watchPosition(p => {
            const coords = [p.coords.latitude, p.coords.longitude];
            const speed = p.coords.speed ? (p.coords.speed * 3.6).toFixed(1) : 0;
            
            if (p.coords.heading !== null && speed > 2) {
                azHistory.push(p.coords.heading);
                if (azHistory.length > 5) azHistory.shift();
            }
            const avgAz = azHistory.length ? averageAngle(azHistory) : lastAzimuth;
            lastAzimuth = avgAz;

            userPlacemark.geometry.setCoordinates(coords);
            userPlacemark.options.set('iconImageHref', createArrowSVG(avgAz, '#007bff'));
            
            if (autoCenter) map.setCenter(coords, map.getZoom(), { duration: 400 });
            checkLogic(coords, speed, avgAz);
        }, err => alert("–í–∫–ª—é—á–∏—Ç–µ GPS –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Safari"), { enableHighAccuracy: true });
    });

    speak("–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞"); 
}

function checkLogic(pos, speed, az) {
    if (!points.length) return;
    const target = points[0];
    const dist = Math.round(getDist(pos[0], pos[1], target.coords[0], target.coords[1]));
    
    document.getElementById('targetText').textContent = target.text;
    document.getElementById('distText').textContent = `${dist} –º`;
    document.getElementById('speedText').textContent = `${speed} –∫–º/—á`;
    document.getElementById('targetAzText').textContent = `–ö—É—Ä—Å: ${target.azimuth}¬∞`;

    const triggerDist = parseInt(document.getElementById('distanceTrigger').value) || 20;

    if (dist <= triggerDist) {
        speak(target.text); // –°—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iPhone, —Ç–∞–∫ –∫–∞–∫ –º—ã "—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏" —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        map.geoObjects.remove(target.placemark);
        points.shift();
        drawRoute();
    }
}

/* ==== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==== */
function getDist(la1, lo1, la2, lo2) {
    const R = 6371000;
    const dLat = (la2 - la1) * Math.PI / 180;
    const dLon = (lo2 - lo1) * Math.PI / 180;
    const a = Math.sin(dLat / 2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function averageAngle(arr) {
    let x = 0, y = 0;
    arr.forEach(a => { x += Math.cos(a * Math.PI / 180); y += Math.sin(a * Math.PI / 180); });
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function createArrowSVG(angle, color, label = '') {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><g transform="rotate(${angle},22,22)"><path d="M22,2 L34,34 L22,28 L10,34 Z" fill="${color}" stroke="white" stroke-width="2"/></g>${label ? `<circle cx="22" cy="22" r="9" fill="white" stroke="black"/><text x="22" y="25" font-size="10" text-anchor="middle" font-family="Arial" font-weight="bold">${label}</text>` : ''}</svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function drawRoute() {
    const container = document.getElementById('targets');
    container.innerHTML = '';
    map.geoObjects.each(o => { if (o !== userPlacemark) map.geoObjects.remove(o); });
    points.forEach((p, i) => {
        const active = i === 0;
        p.placemark = new ymaps.Placemark(p.coords, {}, {
            iconLayout: 'default#image', iconImageHref: createArrowSVG(p.azimuth, active ? '#007bff' : '#ccc', p.id),
            iconImageSize: [40, 40], iconImageOffset: [-20, -20]
        });
        map.geoObjects.add(p.placemark);
        const d = document.createElement('div');
        d.style.padding = "10px";
        if (active) d.style.background = "#f0f7ff";
        d.innerHTML = `<b>${p.id}.</b> ${p.text}`;
        container.appendChild(d);
    });
}

document.getElementById('start').onclick = startApp;
document.getElementById('togglePanelBtn').onclick = () => {
    const p = document.getElementById('panel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
};
document.getElementById('jsonFile').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = () => {
        const d = JSON.parse(reader.result);
        points = d.map((p, i) => ({ id: i + 1, coords: [p.lat, p.lon], azimuth: p.azimuth, text: p.command }));
        drawRoute();
    };
    reader.readAsText(e.target.files[0]);
};
</script>
</body>
</html>
