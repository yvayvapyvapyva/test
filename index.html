<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä: –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<!-- –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

<style>
html, body { margin:0; height:100%; font-family: -apple-system, Arial, sans-serif; overflow: hidden; background: #000; }
#map { width:100%; height:100%; position: absolute; }

/* –≠–∫—Ä–∞–Ω –∑–∞–ø—É—Å–∫–∞ */
#start{position:absolute;inset:0;z-index:100;background:rgba(0,0,0,0.9);color:white;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:20px;cursor:pointer;text-align:center;padding:20px;}
#start small { margin-top: 15px; font-size: 14px; color: #aaa; }

/* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é */
#togglePanelBtn{position:absolute;top:10px;left:10px;z-index:60;width:40px;height:40px;background:white;border:none;border-radius:8px;font-size:22px;box-shadow: 0 2px 5px rgba(0,0,0,0.3);cursor:pointer;}

/* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
#panel{position:absolute;top:60px;left:10px;z-index:50;width:290px;max-height:75%;background:rgba(255,255,255,.98);padding:12px;border-radius:10px;display:none;overflow:auto;box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
#panel label{font-size:12px;font-weight:bold;color:#555;display:block;margin-top:10px;}
#panel input, #panel select, #panel button { width:100%; margin-top:5px; padding:10px; border-radius:6px; border:1px solid #ddd; font-size:14px; box-sizing:border-box; -webkit-appearance: none;}
#panel button { background: #007bff; color:white; border:none; font-weight:bold; margin-top:10px;}

/* –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π */
#targets { margin-top: 15px; border-top: 1px solid #eee; }
#targets div{padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:13px;}
#targets div.active{background:#e7f3ff; font-weight:bold; color:#007bff; border-left:4px solid #007bff;}

/* –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å */
#info{position:absolute;bottom:0;left:0;width:100%;background:rgba(255,255,255,.95);padding:15px;z-index:40;box-sizing:border-box;box-shadow: 0 -2px 10px rgba(0,0,0,0.1);}
.main-info { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
.sub-info { display: flex; justify-content: space-between; font-size: 13px; color: #666; }
</style>
</head>

<body>

<div id="start">
    <b>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞</b>
    <small>–í–∫–ª—é—á–∏—Ç—Å—è GPS, —ç–∫—Ä–∞–Ω –Ω–µ –±—É–¥–µ—Ç –≥–∞—Å–Ω—É—Ç—å <br> –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –æ–∑–≤—É—á–∫–∞</small>
</div>

<button id="togglePanelBtn">‚ò∞</button>

<div id="panel">
    <button onclick="document.getElementById('jsonFile').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
    <input id="jsonFile" type="file" accept=".json" style="display:none">

    <label>–ú–∞—Ä—à—Ä—É—Ç —Å Gist (Github)</label>
    <select id="gistSelect"><option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞... --</option></select>

    <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–º)</label>
    <input id="distanceTrigger" type="number" value="20">

    <label>–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞ (—Ç–æ—á–µ–∫)</label>
    <input id="azAvgCount" type="number" value="5" min="1" max="20">

    <label>–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞</label>
    <select id="voiceSelect"></select>

    <button id="toggleAutoCenter" style="background:#6c757d">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: –í–∫–ª</button>
    
    <div id="targets"></div>
</div>

<div id="info">
    <div class="main-info" id="targetText">–û–∂–∏–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</div>
    <div class="sub-info">
        <span id="distText">–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ---</span>
        <span id="speedText">0 –∫–º/—á</span>
        <span id="targetAzText">–¶–µ–ª—å: ---</span>
    </div>
</div>

<div id="map"></div>

<script>
/* ==== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==== */
let map, userPlacemark, points = [], autoCenter = true, wakeLock = null;
let azHistory = [], lastAzimuth = 0, lastSpeed = 0;
let selectedVoice = null;

/* ==== –°–ò–°–¢–ï–ú–ê –û–ó–í–£–ß–ö–ò (iOS/Android) ==== */
function initVoices() {
    const voices = window.speechSynthesis.getVoices();
    const voiceSelect = document.getElementById('voiceSelect');
    const ruVoices = voices.filter(v => v.lang.includes('ru'));
    
    voiceSelect.innerHTML = '';
    ruVoices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = v.name;
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≥–æ–ª–æ—Å–∞–º Google –∏–ª–∏ Premium (Apple)
        if (v.name.includes('Google') || v.name.includes('Premium')) opt.selected = true;
        voiceSelect.appendChild(opt);
    });
    
    selectedVoice = ruVoices.find(v => v.name.includes('Google')) || 
                    ruVoices.find(v => v.name.includes('Premium')) || 
                    ruVoices[0];
}

// –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤ (–≤–∞–∂–Ω–æ –¥–ª—è Chrome)
window.speechSynthesis.onvoiceschanged = initVoices;

function speak(text) {
    if (!text) return;
    window.speechSynthesis.cancel(); // –°—Ç–æ–ø —Ç–µ–∫—É—â–µ–π —Ä–µ—á–∏
    
    const utter = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    const voiceName = document.getElementById('voiceSelect').value;
    
    utter.voice = voices.find(v => v.name === voiceName) || selectedVoice;
    utter.lang = 'ru-RU';
    utter.rate = 1.0;
    utter.pitch = 1.0;
    window.speechSynthesis.speak(utter);
}

/* ==== –ó–ê–ü–£–°–ö ==== */
document.getElementById('start').onclick = async () => {
    document.getElementById('start').remove();
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–≤—É–∫–∞ –Ω–∞ iOS (–ø—É—Å—Ç–∞—è —Ñ—Ä–∞–∑–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ)
    const unlock = new SpeechSynthesisUtterance('');
    window.speechSynthesis.speak(unlock);
    
    initVoices();
    
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω–∞ —ç–∫—Ä–∞–Ω–∞
    if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
    }
    
    initMap();
    loadGistFiles();
};

/* ==== –ö–ê–†–¢–ê –ò GPS ==== */
function initMap(){
    ymaps.ready(() => {
        map = new ymaps.Map("map", {
            center: [0,0], zoom: 18, type: 'yandex#satellite', controls: []
        });

        userPlacemark = new ymaps.Placemark([0,0], {}, {
            iconLayout: 'default#image',
            iconImageHref: arrowSVG(0, 'red'),
            iconImageSize: [44,44], iconImageOffset: [-22,-22]
        });

        map.geoObjects.add(userPlacemark);
        
        navigator.geolocation.watchPosition(onGPS, (err) => console.error(err), {
            enableHighAccuracy: true, maximumAge: 0, timeout: 5000
        });
    });
}

function onGPS(p){
    const coords = [p.coords.latitude, p.coords.longitude];
    const speed = p.coords.speed ? p.coords.speed * 3.6 : 0;
    lastSpeed = speed.toFixed(1);

    // –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞
    if (p.coords.heading !== null && !isNaN(p.coords.heading) && speed >= 3) {
        azHistory.push(p.coords.heading);
        const maxLen = +document.getElementById('azAvgCount').value || 5;
        if (azHistory.length > maxLen) azHistory.shift();
    }

    const avgAz = azHistory.length ? averageAngle(azHistory) : lastAzimuth;
    lastAzimuth = avgAz;

    userPlacemark.geometry.setCoordinates(coords);
    userPlacemark.options.set('iconImageHref', arrowSVG(avgAz, 'red'));

    if (autoCenter) map.setCenter(coords, map.getZoom(), { duration: 400 });

    checkDistance(coords, lastSpeed, avgAz);
}

/* ==== –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê ==== */
function averageAngle(arr){
    let x=0, y=0;
    arr.forEach(a => {
        const r = a * Math.PI / 180;
        x += Math.cos(r); y += Math.sin(r);
    });
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function getDistance(la1, lo1, la2, lo2){
    const R = 6371000;
    const dLat = (la2-la1)*Math.PI/180;
    const dLon = (lo2-lo1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function arrowSVG(a, color, num = '', active = false) {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><g transform="rotate(${a},22,22)"><polygon points="22,2 34,34 22,28 10,34" fill="${color}" stroke="${active ? '#7CFC00' : 'white'}" stroke-width="2"/></g>${num ? `<circle cx="22" cy="22" r="9" fill="white" stroke="black"/><text x="22" y="25" font-size="10" text-anchor="middle" font-weight="bold">${num}</text>` : ''}</svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* ==== –õ–û–ì–ò–ö–ê –¢–†–ò–ì–ì–ï–†–û–í ==== */
function checkDistance(pos, speed, az){
    if (!points.length) return;

    const p = points[0];
    const dist = Math.round(getDistance(pos[0], pos[1], p.coords[0], p.coords[1]));
    
    document.getElementById('targetText').textContent = p.text;
    document.getElementById('distText').textContent = `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${dist} –º`;
    document.getElementById('speedText').textContent = `${speed} –∫–º/—á`;
    document.getElementById('targetAzText').textContent = `–¶–µ–ª—å: ${p.azimuth}¬∞`;

    const trigger = +document.getElementById('distanceTrigger').value || 20;

    if (dist <= trigger) {
        speak(p.text);
        map.geoObjects.remove(p.placemark);
        points.shift();
        rebuildRoute();
    }
}

/* ==== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==== */
async function loadGistFiles() {
    const gistId = '7d43c5ede26775934e66792a12fe656d';
    try {
        const res = await fetch(`https://api.github.com/gists/${gistId}`);
        const data = await res.json();
        const select = document.getElementById('gistSelect');
        select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option>';
        for (let file in data.files) {
            if (file.endsWith('.json')) {
                const opt = document.createElement('option');
                opt.value = data.files[file].raw_url;
                opt.textContent = file.replace('.json', '');
                select.appendChild(opt);
            }
        }
    } catch (e) { console.error("–û—à–∏–±–∫–∞ Gist", e); }
}

document.getElementById('gistSelect').onchange = async (e) => {
    if (!e.target.value) return;
    const res = await fetch(e.target.value);
    const data = await res.json();
    processPoints(data);
};

document.getElementById('jsonFile').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = () => processPoints(JSON.parse(reader.result));
    reader.readAsText(e.target.files[0]);
};

function processPoints(data) {
    points = data.map((p, i) => ({
        id: i + 1, coords: [p.lat, p.lon], azimuth: p.azimuth, text: p.command, color: p.color
    }));
    rebuildRoute();
}

function rebuildRoute() {
    // –ß–∏—Å—Ç–∏–º –≤—Å—ë –∫—Ä–æ–º–µ —Å—Ç—Ä–µ–ª–∫–∏ —é–∑–µ—Ä–∞
    map.geoObjects.each(o => { if (o !== userPlacemark) map.geoObjects.remove(o); });
    const container = document.getElementById('targets');
    container.innerHTML = '';

    points.forEach((p, i) => {
        const active = i === 0;
        p.placemark = new ymaps.Placemark(p.coords, { balloonContent: p.text }, {
            iconLayout: 'default#image',
            iconImageHref: arrowSVG(p.azimuth, p.color || '#007bff', p.id, active),
            iconImageSize: [40, 40], iconImageOffset: [-20, -20]
        });
        map.geoObjects.add(p.placemark);

        const d = document.createElement('div');
        if (active) d.className = 'active';
        d.innerHTML = `<b>${p.id}.</b> ${p.text} <small>(${p.azimuth}¬∞)</small>`;
        d.onclick = () => { if(confirm("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏?")) { points = points.slice(i); rebuildRoute(); } };
        container.appendChild(d);
    });
}

/* ==== UI –ö–ù–û–ü–ö–ò ==== */
document.getElementById('togglePanelBtn').onclick = () => {
    const p = document.getElementById('panel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
};

document.getElementById('toggleAutoCenter').onclick = (e) => {
    autoCenter = !autoCenter;
    e.target.textContent = `–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: ${autoCenter ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
    e.target.style.background = autoCenter ? '#6c757d' : '#dc3545';
};
</script>
</body>
</html>
