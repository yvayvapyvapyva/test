<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å Edge TTS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; background: #222; }
        
        /* –ó–∞—Å—Ç–∞–≤–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º */
        #start { 
            position: absolute; inset: 0; z-index: 100; 
            background: rgba(0,0,0,0.9); color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; cursor: pointer; padding: 20px;
        }
        #start h1 { font-size: 24px; margin-bottom: 10px; }
        #start p { font-size: 16px; opacity: 0.8; }

        /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é */
        #togglePanelBtn { 
            position: absolute; top: 15px; left: 15px; z-index: 50; 
            width: 44px; height: 44px; background: white; border: none; 
            border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 20px; cursor: pointer;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #panel { 
            position: absolute; top: 70px; left: 15px; z-index: 40; 
            width: 280px; max-height: 70vh; background: white; 
            padding: 15px; border-radius: 12px; display: none; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #panel label { display: block; margin-top: 10px; font-size: 12px; font-weight: bold; color: #666; }
        #panel input, #panel select, #panel button { width: 100%; margin-top: 5px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        #panel button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π */
        #targets { margin-top: 15px; border-top: 1px solid #eee; }
        #targets div { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; }
        #targets div.active { background: #e7f3ff; font-weight: bold; color: #007bff; border-left: 3px solid #007bff; }

        /* –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å —Å–Ω–∏–∑—É */
        #info { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: white; padding: 15px; z-index: 30; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); box-sizing: border-box;
            display: flex; flex-direction: column; gap: 5px;
        }
        .info-row { display: flex; justify-content: space-between; font-size: 14px; }
        .main-text { font-size: 18px; font-weight: bold; color: #000; }
    </style>
</head>

<body>

<div id="start">
    <h1>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h1>
    <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ GPS –∏ –æ–∑–≤—É—á–∫–∏</p>
    <small style="margin-top:20px; color: #aaa;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Microsoft Edge</small>
</div>

<button id="togglePanelBtn">‚ò∞</button>

<div id="panel">
    <button onclick="document.getElementById('jsonFile').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
    <input id="jsonFile" type="file" accept=".json" style="display:none">

    <label>–ú–∞—Ä—à—Ä—É—Ç –∏–∑ Gist (Github)</label>
    <select id="gistSelect"><option value="">-- –ó–∞–≥—Ä—É–∑–∫–∞... --</option></select>

    <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–º)</label>
    <input id="distanceTrigger" type="number" value="20">

    <label>–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
    <input id="azAvgCount" type="number" value="5" min="1" max="20">

    <button id="toggleAutoCenter" style="background:#6c757d">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: –í–∫–ª</button>
    
    <div id="targets"></div>
</div>

<div id="info">
    <div class="main-text" id="targetText">–û–∂–∏–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</div>
    <div class="info-row">
        <span id="distText">–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ---</span>
        <span id="speedText">–°–∫–æ—Ä–æ—Å—Ç—å: 0 –∫–º/—á</span>
    </div>
    <div class="info-row" style="font-size: 11px; color: #888;">
        <span id="azText">–ê–∑–∏–º—É—Ç: ---</span>
        <span id="targetAzText">–¶–µ–ª—å: ---</span>
    </div>
</div>

<div id="map"></div>

<script>
/* ==== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==== */
let map, userPlacemark, points = [], autoCenter = true, wakeLock = null;
let azHistory = [], lastAzimuth = 0, lastSpeed = 0;
let selectedVoice = null;

/* ==== –°–ò–°–¢–ï–ú–ê –û–ó–í–£–ß–ö–ò (EDGE TTS) ==== */
function loadVoices() {
    return new Promise((resolve) => {
        let voices = speechSynthesis.getVoices();
        const findVoice = () => {
            voices = speechSynthesis.getVoices();
            // –ò—â–µ–º –Ω–µ–π—Ä–æ–Ω–Ω–æ–≥–æ –î–º–∏—Ç—Ä–∏—è, –∑–∞—Ç–µ–º –°–≤–µ—Ç–ª–∞–Ω—É, –∑–∞—Ç–µ–º –ª—é–±–æ–π —Ä—É—Å—Å–∫–∏–π –æ–Ω–ª–∞–π–Ω
            selectedVoice = voices.find(v => v.name.includes("Dmitry") && v.name.includes("Online")) ||
                            voices.find(v => v.name.includes("Svetlana") && v.name.includes("Online")) ||
                            voices.find(v => v.lang.includes("ru") && v.name.includes("Online")) ||
                            voices.find(v => v.lang.includes("ru"));
            if (selectedVoice) {
                console.log("–í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å:", selectedVoice.name);
                resolve();
            }
        };
        if (voices.length > 0) findVoice();
        else speechSynthesis.onvoiceschanged = findVoice;
    });
}

function speak(text) {
    if (!text) return;
    speechSynthesis.cancel(); // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ—á—å
    const utterance = new SpeechSynthesisUtterance(text);
    if (selectedVoice) utterance.voice = selectedVoice;
    utterance.lang = 'ru-RU';
    utterance.rate = 0.95; // –ß—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
    utterance.pitch = 1.0;
    
    // –§–∏–∫—Å –¥–ª—è Chrome/Edge (–∏–Ω–æ–≥–¥–∞ —Å–∏–Ω—Ç–µ–∑ "–∑–∞—Å—ã–ø–∞–µ—Ç")
    utterance.onstart = () => { if (speechSynthesis.speaking) console.log("–ì–æ–≤–æ—Ä—é..."); };
    speechSynthesis.speak(utterance);
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫, –µ—Å–ª–∏ –∑–∞–≤–∏—Å–ª–æ
    setTimeout(() => { if (speechSynthesis.speaking) speechSynthesis.resume(); }, 100);
}

/* ==== –õ–û–ì–ò–ö–ê GPS –ò –ö–ê–†–¢–´ ==== */
async function startApp() {
    document.getElementById('start').remove();
    
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–∞
    await loadVoices();
    speak("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –û–∂–∏–¥–∞—é GPS.");

    // 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω–∞ —ç–∫—Ä–∞–Ω–∞
    if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
    }

    // 3. –ö–∞—Ä—Ç–∞
    ymaps.ready(() => {
        map = new ymaps.Map("map", {
            center: [0, 0], zoom: 17, type: 'yandex#satellite', controls: []
        });

        userPlacemark = new ymaps.Placemark([0, 0], {}, {
            iconLayout: 'default#image',
            iconImageHref: createArrowSVG(0, 'red'),
            iconImageSize: [44, 44], iconImageOffset: [-22, -22]
        });

        map.geoObjects.add(userPlacemark);
        
        // –°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –ø–æ–∑–∏—Ü–∏–µ–π
        navigator.geolocation.watchPosition(updatePosition, (err) => console.error(err), {
            enableHighAccuracy: true, maximumAge: 0, timeout: 10000
        });
    });

    loadGistFiles();
}

function updatePosition(p) {
    const coords = [p.coords.latitude, p.coords.longitude];
    const speed = p.coords.speed ? (p.coords.speed * 3.6).toFixed(1) : 0;
    lastSpeed = speed;

    // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞
    if (p.coords.heading !== null && !isNaN(p.coords.heading) && speed > 2) {
        azHistory.push(p.coords.heading);
        if (azHistory.length > (+document.getElementById('azAvgCount').value || 5)) azHistory.shift();
    }
    const avgAz = azHistory.length ? averageAngle(azHistory) : lastAzimuth;
    lastAzimuth = avgAz;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –∏ –∫–∞—Ä—Ç—ã
    userPlacemark.geometry.setCoordinates(coords);
    userPlacemark.options.set('iconImageHref', createArrowSVG(avgAz, 'red'));
    if (autoCenter) map.setCenter(coords, map.getZoom(), { duration: 500 });

    checkLogic(coords, speed, avgAz);
}

function checkLogic(userCoords, speed, userAz) {
    if (!points.length) return;

    const target = points[0];
    const dist = Math.round(calculateDistance(userCoords[0], userCoords[1], target.coords[0], target.coords[1]));
    
    // –†–∞–∑–Ω–∏—Ü–∞ —É–≥–ª–æ–≤ (—á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ, –µ—Å–ª–∏ –∏–¥–µ–º –≤ –æ–±—Ä–∞—Ç–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É)
    const azDiff = Math.abs(((Math.round(userAz) - target.azimuth + 540) % 360) - 180);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    document.getElementById('targetText').textContent = target.text;
    document.getElementById('distText').textContent = `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${dist} –º`;
    document.getElementById('speedText').textContent = `${speed} –∫–º/—á`;
    document.getElementById('azText').textContent = `–ê–∑–∏–º—É—Ç: ${Math.round(userAz)}¬∞`;
    document.getElementById('targetAzText').textContent = `–¶–µ–ª—å: ${target.azimuth}¬∞`;

    // –£—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    const triggerDist = +document.getElementById('distanceTrigger').value || 20;
    if (dist <= triggerDist && azDiff <= 60) {
        speak(target.text);
        map.geoObjects.remove(target.placemark);
        points.shift();
        renderRoute();
    }
}

/* ==== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==== */
function averageAngle(arr) {
    let x = 0, y = 0;
    arr.forEach(a => {
        let r = a * Math.PI / 180;
        x += Math.cos(r); y += Math.sin(r);
    });
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function createArrowSVG(angle, color, label = '', active = false) {
    const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44">
        <g transform="rotate(${angle},22,22)">
            <path d="M22,2 L34,34 L22,28 L10,34 Z" fill="${color}" stroke="white" stroke-width="2" />
        </g>
        ${label ? `<circle cx="22" cy="22" r="8" fill="white" stroke="black" />
        <text x="22" y="26" font-size="10" text-anchor="middle" font-weight="bold">${label}</text>` : ''}
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function renderRoute() {
    const container = document.getElementById('targets');
    container.innerHTML = '';
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏ (–∫—Ä–æ–º–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞)
    map.geoObjects.each(o => { if (o !== userPlacemark) map.geoObjects.remove(o); });

    points.forEach((p, i) => {
        const isActive = i === 0;
        
        // –ú–µ—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
        p.placemark = new ymaps.Placemark(p.coords, { hintContent: p.text }, {
            iconLayout: 'default#image',
            iconImageHref: createArrowSVG(p.azimuth, p.color || '#007bff', p.id, isActive),
            iconImageSize: [40, 40], iconImageOffset: [-20, -20]
        });
        map.geoObjects.add(p.placemark);

        // –°—Ç—Ä–æ–∫–∞ –≤ —Å–ø–∏—Å–∫–µ
        const div = document.createElement('div');
        div.className = isActive ? 'active' : '';
        div.innerHTML = `<b>${p.id}.</b> ${p.text} <br><small>${p.azimuth}¬∞</small>`;
        div.onclick = () => {
            if (confirm("–ü–µ—Ä–µ–ø—Ä—ã–≥–Ω—É—Ç—å –∫ —ç—Ç–æ–π —Ç–æ—á–∫–µ?")) {
                points = points.slice(i);
                renderRoute();
            }
        };
        container.appendChild(div);
    });
}

/* ==== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==== */
async function loadGistFiles() {
    const gistId = '7d43c5ede26775934e66792a12fe656d';
    try {
        const res = await fetch(`https://api.github.com/gists/${gistId}`);
        const data = await res.json();
        const select = document.getElementById('gistSelect');
        select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option>';
        for (let file in data.files) {
            if (file.endsWith('.json')) {
                const opt = document.createElement('option');
                opt.value = data.files[file].raw_url;
                opt.textContent = file.replace('.json', '');
                select.appendChild(opt);
            }
        }
    } catch (e) { console.error("Gist error", e); }
}

document.getElementById('gistSelect').onchange = async (e) => {
    if (!e.target.value) return;
    const res = await fetch(e.target.value);
    const data = await res.json();
    points = data.map((p, i) => ({
        id: i + 1, coords: [p.lat, p.lon], azimuth: p.azimuth, text: p.command, color: p.color
    }));
    renderRoute();
};

document.getElementById('jsonFile').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = () => {
        const data = JSON.parse(reader.result);
        points = data.map((p, i) => ({
            id: i + 1, coords: [p.lat, p.lon], azimuth: p.azimuth, text: p.command, color: p.color
        }));
        renderRoute();
    };
    reader.readAsText(e.target.files[0]);
};

/* ==== UI –ò–í–ï–ù–¢–´ ==== */
document.getElementById('start').onclick = startApp;
document.getElementById('togglePanelBtn').onclick = () => {
    const p = document.getElementById('panel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
};
document.getElementById('toggleAutoCenter').onclick = (e) => {
    autoCenter = !autoCenter;
    e.target.textContent = `–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: ${autoCenter ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
    e.target.style.background = autoCenter ? '#6c757d' : '#dc3545';
};

</script>
</body>
</html>
