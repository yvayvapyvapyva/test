<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>
    <style>
        body, html { margin: 0; height: 100%; font-family: 'Inter', Arial, sans-serif; overflow: hidden; }
        #map { position: absolute; inset: 0; }
        #start { position: absolute; inset: 0; z-index: 2000; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        #panel { position: absolute; top: 10px; right: 10px; width: 300px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px); transition: 0.3s; display: none; }
        #panel.collapsed { transform: translateY(-150%); opacity: 0; pointer-events: none; }
        #togglePanel, #toggleLabelsBtn { position: absolute; right: 20px; z-index: 1001; width: 50px; height: 50px; border-radius: 25px; border: none; background: #2f80ed; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; transition: background 0.2s; }
        #togglePanel { bottom: 85px; }
        #toggleLabelsBtn { bottom: 145px; font-size: 20px; }
        #info { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); padding: 12px; font-weight: bold; font-size: 14px; z-index: 15; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 1px solid #ddd; min-height: 40px; box-sizing: border-box; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        button, select { flex: 1; cursor: pointer; border: none; border-radius: 8px; padding: 10px 5px; background: #2f80ed; color: white; font-weight: bold; min-height: 44px; display: flex; align-items: center; justify-content: center; font-family: inherit; font-size: 14px; }
        select { background: #fff; color: #000; border: 1px solid #ddd; width: 100%; }
        button.secondary { background: #6c757d; }
        button.check-btn { background: #27ae60; }
        button.check-btn.active { background: #e74c3c; }
        #targets { max-height: 200px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #eee; }
        #targets div { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
        #targets div.active { background: #e3f2fd; font-weight: bold; border-left: 3px solid #2f80ed; }
        #targets div.playing { background: #d4edda; border-left: 3px solid #27ae60; }
        #targets div.passed { color: #999; text-decoration: line-through; }
        .cmd-bubble { position: relative; background: #fff; border: 2px solid #333; border-radius: 6px; padding: 4px 8px; font-size: 12px; font-weight: bold; color: #000; }
        #audioProgress { height: 4px; background: #eee; border-radius: 2px; margin-top: 8px; display: none; overflow: hidden; }
        #audioProgressBar { height: 100%; background: #27ae60; width: 0%; transition: width 0.3s; }
        @media (max-width: 480px) { #panel { width: auto; left: 10px; right: 10px; } }
    </style>
</head>
<body>

<div id="start">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞</div>
<button id="toggleLabelsBtn" onclick="toggleLabels()">üëÅÔ∏è</button>
<button id="togglePanel" onclick="togglePanelUI()">‚â°</button>

<div id="panel">
    <select id="roadSelect" onchange="loadRoadFromServer(this.value)" style="margin-bottom:8px;">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option>
    </select>
    <div class="row">
        <button onclick="document.getElementById('jsonFile').click()">üìÇ –°–≤–æ–π JSON</button>
        <button id="checkAllBtn" class="check-btn" onclick="toggleCheckAll()">‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—ë</button>
    </div>
    <input id="jsonFile" type="file" accept=".json" style="display:none" onchange="loadLocalJSON(event)">
    <div id="audioProgress"><div id="audioProgressBar"></div></div>
    <div style="margin-top:10px;">
        <label style="font-size:12px; font-weight:bold;">–¢—Ä–∏–≥–≥–µ—Ä (–º)</label>
        <input id="distanceTrigger" type="number" value="20" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; margin-top:4px; box-sizing: border-box;">
    </div>
    <div class="row" style="margin-top:10px;">
        <button id="toggleAutoCenter" class="secondary" onclick="toggleCenter()">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: –í–∫–ª</button>
    </div>
    <div id="targets"></div>
</div>

<div id="info">–û–∂–∏–¥–∞–Ω–∏–µ GPS‚Ä¶</div>
<div id="map"></div>

<script>
function nocache(url) {
    return url + (url.indexOf('?') === -1 ? '?' : '&') + 't=' + new Date().getTime();
}

let map, userPlacemark, points = [], currentIndex = 0, autoCenter = true, showLabels = false, currentRoadFolder = '';
let audioCache = {}; 
let isCheckingAll = false;
let checkTimeout = null;

document.getElementById('start').onclick = async function() {
    this.remove(); 
    document.getElementById('panel').style.display = 'block'; 
    document.getElementById('togglePanel').style.display = 'flex';
    document.getElementById('toggleLabelsBtn').style.display = 'flex';
    new Audio().play().catch(()=>{}); 
    speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    initMap(); 
    loadRoadList();
};

async function loadRoadList() {
    try {
        const res = await fetch(nocache('roads/list.json'));
        const list = await res.json();
        const sel = document.getElementById('roadSelect');
        sel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option>';
        list.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.file; opt.textContent = r.name || r.file;
            sel.appendChild(opt);
        });
    } catch(e) { console.error("–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞:", e); }
}

async function loadRoadFromServer(file) {
    if (!file) return;
    currentRoadFolder = 'roads/' + file.replace('.json', '');
    try {
        const res = await fetch(nocache('roads/' + file));
        processJSON(await res.json());
    } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); }
}

function processJSON(data) {
    points = data.map(p => ({ id: p.id, coords: [+p.lat, +p.lon], azimuth: p.azimuth, text: p.command || '', color: p.color || 'Gold', hasAudio: false }));
    currentIndex = 0; 
    rebuildRoute();
    preloadAudio();
}

async function preloadAudio() {
    const bar = document.getElementById('audioProgressBar');
    const container = document.getElementById('audioProgress');
    container.style.display = 'block';
    bar.style.width = '0%';
    
    Object.values(audioCache).forEach(url => URL.revokeObjectURL(url));
    audioCache = {};

    let loaded = 0;
    for (const p of points) {
        try {
            const res = await fetch(nocache(`${currentRoadFolder}/${p.id}.mp3`));
            if (res.ok) {
                const blob = await res.blob();
                audioCache[p.id] = URL.createObjectURL(blob);
                p.hasAudio = true;
            }
        } catch (e) {}
        loaded++;
        bar.style.width = (loaded / points.length * 100) + '%';
    }
    rebuildRoute();
    setTimeout(() => container.style.display = 'none', 800);
}

function playPointVoice(p) {
    return new Promise((resolve) => {
        let played = false;
        const sayTTS = () => {
            if (played) return;
            played = true;
            const ut = new SpeechSynthesisUtterance(p.text);
            ut.lang = 'ru-RU';
            ut.onend = () => resolve();
            speechSynthesis.speak(ut);
        };

        if (audioCache[p.id]) {
            const audio = new Audio(audioCache[p.id]);
            audio.onended = () => resolve();
            audio.onerror = sayTTS;
            audio.play().then(() => played = true).catch(sayTTS);
        } else {
            sayTTS();
        }
    });
}

async function toggleCheckAll() {
    const btn = document.getElementById('checkAllBtn');
    if (isCheckingAll) {
        isCheckingAll = false;
        btn.textContent = '‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—ë';
        btn.classList.remove('active');
        speechSynthesis.cancel();
        rebuildRoute();
        return;
    }

    isCheckingAll = true;
    btn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
    btn.classList.add('active');

    for (let i = 0; i < points.length; i++) {
        if (!isCheckingAll) break;
        highlightPlaying(i);
        await playPointVoice(points[i]);
        await new Promise(r => setTimeout(r, 500));
    }

    isCheckingAll = false;
    btn.textContent = '‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—ë';
    btn.classList.remove('active');
    rebuildRoute();
}

function highlightPlaying(idx) {
    const divs = document.querySelectorAll('#targets div');
    divs.forEach((d, i) => {
        d.classList.toggle('playing', i === idx);
    });
}

function initMap(){
    ymaps.ready(() => {
        map = new ymaps.Map("map", { center:[0,0], zoom:18, type:'yandex#satellite', controls:[] });
        userPlacemark = new ymaps.Placemark([0,0],{},{ iconLayout:'default#image', iconImageHref: getIcon(0, 'red', false, '', 1), iconImageSize:[40,40], iconImageOffset:[-20,-20] });
        map.geoObjects.add(userPlacemark);
        navigator.geolocation.watchPosition(onGPS, null, {enableHighAccuracy:true});
    });
}

function onGPS(p){
    const c = [p.coords.latitude, p.coords.longitude];
    userPlacemark.geometry.setCoordinates(c);
    if (autoCenter) map.setCenter(c);
    checkDistance(c, p.coords.speed * 3.6 || 0, p.coords.heading || 0);
}

function checkDistance(pos, speed, az){
    if (currentIndex >= points.length || isCheckingAll) return;
    const p = points[currentIndex];
    const dist = Math.round(getDistance(pos[0], pos[1], p.coords[0], p.coords[1]));
    updateInfoUI(p, dist, az, speed.toFixed(1));
    if (dist <= (+document.getElementById('distanceTrigger').value || 20)) {
        playPointVoice(p);
        currentIndex++;
        rebuildRoute();
    }
}

function rebuildRoute() {
    if(!map) return;
    const toRemove = []; 
    map.geoObjects.each(o => { if(o !== userPlacemark) toRemove.push(o); });
    toRemove.forEach(o => map.geoObjects.remove(o));

    const list = document.getElementById('targets'); 
    list.innerHTML = '';

    points.forEach((p, i) => {
        const active = i === currentIndex, passed = i < currentIndex, op = passed ? 0.3 : 1;
        const placemark = new ymaps.Placemark(p.coords, { iconContent: (showLabels && !passed) ? p.text : "" }, { 
            iconLayout:'default#imageWithContent', iconImageHref: getIcon(p.azimuth, p.color, active, p.id, op), iconImageSize:[40,40], iconImageOffset:[-20,-20], iconContentOffset: [40, -10],
            iconContentLayout: ymaps.templateLayoutFactory.createClass('<div class="cmd-bubble">$[properties.iconContent]</div>')
        });
        map.geoObjects.add(placemark);

        const d = document.createElement('div'); 
        const audioIcon = p.hasAudio ? ' <span style="color:#27ae60">üîä</span>' : ' <span style="color:#e67e22">ü§ñ</span>';
        d.innerHTML = `<strong>${p.id}</strong>. ${p.text} ${audioIcon}`;
        if(active) d.className = 'active'; 
        if(passed) d.className = 'passed';
        d.onclick = () => { currentIndex = i; rebuildRoute(); playPointVoice(p); };
        list.appendChild(d);
    });
}

function getIcon(az, col, sel, id, op = 1) {
    const fill = col || 'Gold', strk = sel ? '#2ecc71' : '#000';
    const inner = id ? `<circle cx="20" cy="20" r="9" fill="white" fill-opacity="${op}" stroke="${fill}" stroke-opacity="${op}" stroke-width="2"/><text x="20" y="24" font-size="11" font-family="Arial" font-weight="900" text-anchor="middle" fill="black" fill-opacity="${op}">${id}</text>` : '';
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${az},20,20)" opacity="${op}"><polygon points="20,2 35,35 20,26 5,35" fill="${fill}" stroke="${strk}" stroke-width="${sel?3:1.5}"/></g>${inner}</svg>`);
}

function updateInfoUI(p, d, az, s) {
    document.getElementById('info').innerHTML = p ? `‚Ññ${p.id} | ${p.text}<br>–î–∏—Å—Ç: ${d}–º | –¶–µ–ª—å: ${p.azimuth}¬∞ | ${s} –∫–º/—á` : '–ú–∞—Ä—à—Ä—É—Ç –ø—Ä–æ–π–¥–µ–Ω';
}

function getDistance(a,b,c,d){
    const R=6371000, rLat=(c-a)*Math.PI/180, rLon=(d-b)*Math.PI/180;
    const x=Math.sin(rLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(rLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function togglePanelUI() { document.getElementById('panel').classList.toggle('collapsed'); }
function toggleCenter() { autoCenter = !autoCenter; document.getElementById('toggleAutoCenter').textContent = '–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: '+(autoCenter?'–í–∫–ª':'–í—ã–∫–ª'); }
function toggleLabels() { showLabels = !showLabels; rebuildRoute(); }
</script>
</body>
</html>
