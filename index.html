<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä: –ù–µ–π—Ä–æ–Ω–Ω—ã–π –ì–æ–ª–æ—Å</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã (–ó–∞–º–µ–Ω–∏—Ç–µ –í–ê–®_API_–ö–õ–Æ–ß –Ω–∞ —Å–≤–æ–π) -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; position: absolute; }
        
        /* –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ä—Ç–∞ */
        #start { 
            position: absolute; inset: 0; z-index: 100; 
            background: #111; color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; text-align: center; padding: 20px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ú–µ–Ω—é */
        #togglePanelBtn { 
            position: absolute; top: 15px; left: 15px; z-index: 50; 
            width: 44px; height: 44px; background: white; border: none; border-radius: 50%; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 20px; cursor: pointer;
        }

        /* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        #panel { 
            position: absolute; top: 70px; left: 15px; z-index: 40; 
            width: 300px; max-height: 75vh; background: white; 
            padding: 15px; border-radius: 12px; display: none; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        select, input, button { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å —Å–Ω–∏–∑—É */
        #info { 
            position: absolute; bottom: 0; width: 100%; background: white; 
            padding: 15px; z-index: 30; box-shadow: 0 -2px 15px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .main-text { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: #000; }
        .stats { display: flex; justify-content: space-between; font-size: 13px; color: #555; }

        /* –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π –≤ –º–µ–Ω—é */
        #targets { margin-top: 10px; }
        #targets div { padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 13px; cursor: pointer; }
        #targets div.active { color: #007bff; font-weight: bold; background: #f0f7ff; }
    </style>
</head>
<body>

<div id="start">
    <h1 style="margin-bottom:10px">–ù–∞–≤–∏–≥–∞—Ç–æ—Ä</h1>
    <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ GPS –∏ –∑–≤—É–∫–∞</p>
    <p style="font-size: 12px; color: #666; margin-top: 20px;">–î–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Microsoft Edge</p>
</div>

<button id="togglePanelBtn">‚ò∞</button>

<div id="panel">
    <div class="group">
        <label>–ì–æ–ª–æ—Å –æ–∑–≤—É—á–∫–∏</label>
        <select id="voiceSelect"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤...</option></select>
        <button onclick="testVoice()" style="background:#f8f9fa; color:#333; margin-top:8px; border:1px solid #ddd">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ–ª–æ—Å</button>
    </div>

    <div class="group">
        <label>–ú–∞—Ä—à—Ä—É—Ç</label>
        <button onclick="document.getElementById('jsonFile').click()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
        <input id="jsonFile" type="file" accept=".json" style="display:none">
        <select id="gistSelect" style="margin-top:10px"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞ Gists...</option></select>
    </div>

    <div class="group">
        <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞: <span id="distVal">20</span>–º</label>
        <input type="range" id="distanceTrigger" min="5" max="100" value="20" oninput="distVal.textContent=value">
    </div>

    <div id="targets"></div>
</div>

<div id="info">
    <div class="main-text" id="targetText">–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>
    <div class="stats">
        <span id="distText">–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ---</span>
        <span id="speedText">0 –∫–º/—á</span>
        <span id="targetAzText">–¶–µ–ª—å: ---</span>
    </div>
</div>

<div id="map"></div>

<script>
let map, userPlacemark, points = [], autoCenter = true;
let azHistory = [], lastAzimuth = 0;
let currentVoice = null;

/* ==== –õ–û–ì–ò–ö–ê –û–ó–í–£–ß–ö–ò (Microsoft Edge Natural) ==== */
function initVoices() {
    const voiceSelect = document.getElementById('voiceSelect');
    
    function updateList() {
        let voices = speechSynthesis.getVoices();
        if (voices.length === 0) return;

        voiceSelect.innerHTML = '';
        const ruVoices = voices.filter(v => v.lang.includes('ru'));

        ruVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ–π—Ä–æ–Ω–Ω—ã–π –ª–∏ —ç—Ç–æ –≥–æ–ª–æ—Å (Edge Online)
            const isNeural = voice.name.includes('Online') || voice.name.includes('Natural');
            option.textContent = isNeural ? "‚≠ê " + voice.name : voice.name;
            
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞: –î–º–∏—Ç—Ä–∏–π –∏–ª–∏ –°–≤–µ—Ç–ª–∞–Ω–∞ (Online)
            if (!currentVoice) {
                if (voice.name.includes('Dmitry') && isNeural) {
                    option.selected = true;
                    currentVoice = voice;
                } else if (voice.name.includes('Svetlana') && isNeural && !currentVoice) {
                    option.selected = true;
                    currentVoice = voice;
                }
            } else if (currentVoice.name === voice.name) {
                option.selected = true;
            }
            
            voiceSelect.appendChild(option);
        });
        
        if (!currentVoice && ruVoices.length > 0) currentVoice = ruVoices[0];
    }

    // Edge –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç Online –≥–æ–ª–æ—Å–∞ —á—É—Ç—å –ø–æ–∑–∂–µ, –ø–æ—ç—Ç–æ–º—É –æ–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
    updateList();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = updateList;
    }
    // –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ 1 –∏ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(updateList, 1000);
    setTimeout(updateList, 3000);

    voiceSelect.onchange = () => {
        currentVoice = speechSynthesis.getVoices().find(v => v.name === voiceSelect.value);
        speak("–ì–æ–ª–æ—Å –≤—ã–±—Ä–∞–Ω");
    };
}

function speak(text) {
    if (!text) return;
    window.speechSynthesis.cancel(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ—á—å
    const utter = new SpeechSynthesisUtterance(text);
    if (currentVoice) utter.voice = currentVoice;
    utter.lang = 'ru-RU';
    utter.rate = 1.0;
    utter.pitch = 1.0;
    
    // –§–∏–∫—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ "—Ä–∞–∑–±—É–¥–∏—Ç—å" —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä
    window.speechSynthesis.speak(utter);
    
    // –ó–∞–ø–ª–∞—Ç–∫–∞ –¥–ª—è –∑–∞–≤–∏—Å–∞–Ω–∏–π –≤ Chrome/Edge
    let r = setInterval(() => {
        if (!speechSynthesis.speaking) clearInterval(r);
        else speechSynthesis.resume();
    }, 1000);
}

function testVoice() {
    if (!currentVoice) { alert("–ì–æ–ª–æ—Å–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"); return; }
    speak("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏. –≠—Ç–æ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–æ–ª–æ—Å.");
}

/* ==== –ì–ï–û–õ–û–ö–ê–¶–ò–Ø –ò –ö–ê–†–¢–ê ==== */
async function startApp() {
    document.getElementById('start').remove();
    initVoices(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤
    
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞
    if ('wakeLock' in navigator) {
        try { await navigator.wakeLock.request('screen'); } catch(e){}
    }

    ymaps.ready(() => {
        map = new ymaps.Map("map", {
            center: [0, 0], zoom: 18, type: 'yandex#satellite', controls: []
        });

        userPlacemark = new ymaps.Placemark([0, 0], {}, {
            iconLayout: 'default#image',
            iconImageHref: createArrowSVG(0, 'red'),
            iconImageSize: [44, 44], iconImageOffset: [-22, -22]
        });

        map.geoObjects.add(userPlacemark);
        
        // –ó–∞–ø—É—Å–∫ GPS
        navigator.geolocation.watchPosition(p => {
            const coords = [p.coords.latitude, p.coords.longitude];
            const speed = p.coords.speed ? (p.coords.speed * 3.6).toFixed(1) : 0;
            
            // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∞–∑–∏–º—É—Ç–∞
            if (p.coords.heading !== null && speed > 2) {
                azHistory.push(p.coords.heading);
                if (azHistory.length > 5) azHistory.shift();
            }
            const avgAz = azHistory.length ? averageAngle(azHistory) : lastAzimuth;
            lastAzimuth = avgAz;

            userPlacemark.geometry.setCoordinates(coords);
            userPlacemark.options.set('iconImageHref', createArrowSVG(avgAz, 'red'));
            
            if (autoCenter) map.setCenter(coords, map.getZoom(), { duration: 400 });

            checkLogic(coords, speed, avgAz);
        }, err => console.error(err), { enableHighAccuracy: true });
    });

    loadGist();
    // –ü–µ—Ä–≤—ã–π "—Ç–∏—Ö–∏–π" –∑–∞–ø—É—Å–∫ –∑–≤—É–∫–∞ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞—É–¥–∏–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    speak(""); 
}

function checkLogic(pos, speed, az) {
    if (!points.length) return;
    const target = points[0];
    const dist = Math.round(getDist(pos[0], pos[1], target.coords[0], target.coords[1]));
    
    // –†–∞–∑–Ω–∏—Ü–∞ —É–≥–ª–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –±–æ–ª—Ç–∞–ª–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å–ø–∏–Ω–æ–π)
    const azDiff = Math.abs(((Math.round(az) - target.azimuth + 540) % 360) - 180);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    document.getElementById('targetText').textContent = target.text;
    document.getElementById('distText').textContent = `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${dist} –º`;
    document.getElementById('speedText').textContent = `${speed} –∫–º/—á`;
    document.getElementById('targetAzText').textContent = `–¶–µ–ª—å: ${target.azimuth}¬∞`;

    // –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
    const triggerDist = +document.getElementById('distanceTrigger').value;
    if (dist <= triggerDist && azDiff <= 60) {
        speak(target.text);
        map.geoObjects.remove(target.placemark);
        points.shift();
        drawRoute();
    }
}

/* ==== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==== */
function getDist(la1, lo1, la2, lo2) {
    const R = 6371000;
    const dLat = (la2 - la1) * Math.PI / 180;
    const dLon = (lo2 - lo1) * Math.PI / 180;
    const a = Math.sin(dLat / 2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function averageAngle(arr) {
    let x = 0, y = 0;
    arr.forEach(a => { x += Math.cos(a * Math.PI / 180); y += Math.sin(a * Math.PI / 180); });
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function createArrowSVG(angle, color, label = '', active = false) {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44"><g transform="rotate(${angle},22,22)"><path d="M22,2 L34,34 L22,28 L10,34 Z" fill="${color}" stroke="white" stroke-width="2"/></g>${label ? `<circle cx="22" cy="22" r="9" fill="white" stroke="black"/><text x="22" y="25" font-size="10" text-anchor="middle" font-family="Arial" font-weight="bold">${label}</text>` : ''}</svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function drawRoute() {
    const container = document.getElementById('targets');
    container.innerHTML = '';
    
    // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏
    map.geoObjects.each(o => { if (o !== userPlacemark) map.geoObjects.remove(o); });

    points.forEach((p, i) => {
        const active = i === 0;
        p.placemark = new ymaps.Placemark(p.coords, { hintContent: p.text }, {
            iconLayout: 'default#image', 
            iconImageHref: createArrowSVG(p.azimuth, p.color || '#007bff', p.id, active),
            iconImageSize: [40, 40], iconImageOffset: [-20, -20]
        });
        map.geoObjects.add(p.placemark);

        const d = document.createElement('div');
        d.className = active ? 'active' : '';
        d.innerHTML = `<b>${p.id}.</b> ${p.text} <small>(${p.azimuth}¬∞)</small>`;
        d.onclick = () => { if(confirm("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏?")) { points = points.slice(i); drawRoute(); } };
        container.appendChild(d);
    });
}

async function loadGist() {
    try {
        const res = await fetch(`https://api.github.com/gists/7d43c5ede26775934e66792a12fe656d`);
        const data = await res.json();
        const s = document.getElementById('gistSelect');
        s.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ Gist --</option>';
        for (let f in data.files) {
            if (f.endsWith('.json')) {
                const o = document.createElement('option');
                o.value = data.files[f].raw_url;
                o.textContent = f.replace('.json','');
                s.appendChild(o);
            }
        }
        s.onchange = async () => {
            const r = await fetch(s.value);
            const d = await r.json();
            points = d.map((p, i) => ({ id: i + 1, coords: [p.lat, p.lon], azimuth: p.azimuth, text: p.command, color: p.color }));
            drawRoute();
        };
    } catch(e){ console.error("Gist load failed"); }
}

/* ==== –°–û–ë–´–¢–ò–Ø ==== */
document.getElementById('jsonFile').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = () => {
        const d = JSON.parse(reader.result);
        points = d.map((p, i) => ({ id: i + 1, coords: [p.lat, p.lon], azimuth: p.azimuth, text: p.command, color: p.color }));
        drawRoute();
    };
    reader.readAsText(e.target.files[0]);
};

document.getElementById('togglePanelBtn').onclick = () => {
    const p = document.getElementById('panel');
    p.style.display = p.style.display === 'block' ? 'none' : 'block';
};

document.getElementById('start').onclick = startApp;

</script>
</body>
</html>
