<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>
<style>
    body, html { margin: 0; height: 100%; font-family: 'Inter', Arial, sans-serif; overflow: hidden; background: #000; }
    #map { position: absolute; inset: 0; }
    #start { position: absolute; inset: 0; z-index: 2000; background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; text-align: center; padding: 20px; }
    
    #panel { position: absolute; top: 10px; right: 10px; width: 300px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px); transition: 0.3s; display: none; }
    #panel.collapsed { transform: translateY(-150%); opacity: 0; pointer-events: none; }
    
    #togglePanel, #toggleLabelsBtn { position: absolute; right: 20px; z-index: 1001; width: 50px; height: 50px; border-radius: 25px; border: none; background: #2f80ed; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; }
    #togglePanel { bottom: 85px; }
    #toggleLabelsBtn { bottom: 145px; font-size: 20px; }

    #info { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); padding: 12px; font-weight: bold; font-size: 14px; z-index: 15; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 1px solid #ddd; min-height: 50px; box-sizing: border-box; }
    
    .row { display: flex; gap: 8px; margin-bottom: 8px; }
    button, select { flex: 1; cursor: pointer; border: none; border-radius: 8px; padding: 10px 5px; background: #2f80ed; color: white; font-weight: bold; min-height: 44px; display: flex; align-items: center; justify-content: center; font-family: inherit; font-size: 14px; }
    select { background: #fff; color: #000; border: 1px solid #ddd; display: block; width: 100%; }
    
    #targets { max-height: 300px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #eee; }
    .target-item { padding: 10px 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; display: flex; flex-direction: column; }
    .target-item.active { background: #e3f2fd; font-weight: bold; border-left: 4px solid #2f80ed; }
    .target-item.passed { opacity: 0.5; filter: grayscale(0.5); }
    
    .target-main { display: flex; align-items: center; width: 100%; }
    .target-content { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .audio-icon { margin-right: 10px; font-style: normal; cursor: pointer; width: 24px; text-align: center; font-size: 18px; }
    
    .comment-toggle { background: #eee; border-radius: 4px; padding: 2px 6px; font-size: 12px; margin-left: 5px; cursor: pointer; border: 1px solid #ccc; }
    .target-comment { display: none; font-size: 11px; font-weight: normal; color: #444; margin-top: 8px; padding: 6px; background: #fff9e6; border-radius: 4px; border-left: 2px solid #ffd700; word-wrap: break-word; }
    .target-comment.visible { display: block; }

    .cmd-bubble { position: relative; background: #fff; border: 2px solid #333; border-radius: 6px; padding: 4px 8px; font-size: 12px; font-weight: bold; color: #000; box-shadow: 2px 2px 6px rgba(0,0,0,0.3); display: inline-block; max-width: 180px; word-wrap: break-word; }
    #audioProgress { height: 4px; background: #eee; border-radius: 2px; margin-top: 8px; display: none; overflow: hidden; }
    #audioProgressBar { height: 100%; background: #27ae60; width: 0%; transition: width 0.3s; }

    @media (max-width: 480px) { #panel { width: auto; left: 10px; right: 10px; } }
</style>
</head>
<body>

<div id="start">
    <b>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞</b>
    <span style="font-size: 14px; margin-top: 10px; opacity: 0.8;">–ê–∫—Ç–∏–≤–∞—Ü–∏—è GPS, –∑–≤—É–∫–∞ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞</span>
</div>

<button id="toggleLabelsBtn" onclick="toggleLabels()">üëÅÔ∏è</button>
<button id="togglePanel" onclick="togglePanelUI()">‚â°</button>

<div id="panel">
    <select id="roadSelect" onchange="loadRoadFromServer(this.value)" style="margin-bottom:8px;">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option>
    </select>
    <div class="row">
        <button onclick="document.getElementById('jsonFile').click()">üìÇ –°–≤–æ–π JSON</button>
    </div>
    <input id="jsonFile" type="file" accept=".json" style="display:none" onchange="loadLocalJSON(event)">
    <div id="audioProgress"><div id="audioProgressBar"></div></div>
    
    <div style="margin-top:10px;">
        <label style="font-size:11px; font-weight:bold; color: #555;">–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–º):</label>
        <input id="distanceTrigger" type="number" value="20" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; margin-top:4px; box-sizing: border-box;">
    </div>
    
    <div class="row" style="margin-top:10px;">
        <button id="toggleAutoCenter" style="background:#6c757d" onclick="toggleCenter()">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: –í–∫–ª</button>
    </div>
    <div id="targets"></div>
</div>

<div id="info">–û–∂–∏–¥–∞–Ω–∏–µ GPS‚Ä¶</div>
<div id="map"></div>

<script>
let map, userPlacemark, points = [], currentIndex = 0, autoCenter = true, showLabels = false, wakeLock = null;
let azHistory = [], lastAzimuth = 0, currentRoadFolder = 'roads';
let audioCache = {}, audioStatus = {}; 
const COLOR_MAP = { 'Gold': '#FFD700', 'blue': '#0000FF', 'red': '#FF0000', 'Lime': '#00FF00', 'Fuchsia': '#FF00FF', 'purple': '#800080', 'Silver': '#C0C0C0', 'Aqua': '#00FFFF' };

// –£—Ç–∏–ª–∏—Ç–∞ –∞–Ω—Ç–∏-–∫—ç—à–∞
function getNoCacheUrl(url) {
    return `${url}${url.includes('?') ? '&' : '?'}_=${Date.now()}`;
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —ç–∫—Ä–∞–Ω–∞
async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
}

document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && !document.getElementById('start')) {
        await requestWakeLock();
    }
});

// –°–¢–ê–†–¢
document.getElementById('start').onclick = async function() {
    this.remove(); 
    document.getElementById('panel').style.display = 'block'; 
    document.getElementById('togglePanel').style.display = 'flex';
    document.getElementById('toggleLabelsBtn').style.display = 'flex';
    
    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞—É–¥–∏–æ –¥–ª—è iOS
    const silentAudio = new Audio();
    silentAudio.play().catch(()=>{});
    speechSynthesis.speak(new SpeechSynthesisUtterance(''));

    await requestWakeLock();
    ymaps.ready(initMap); 
    loadRoadList();
};

async function loadRoadList() {
    try {
        const res = await fetch(getNoCacheUrl('roads/list.json'));
        const list = await res.json();
        const sel = document.getElementById('roadSelect');
        list.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.file; opt.textContent = r.name || r.file;
            sel.appendChild(opt);
        });
    } catch(e) { console.error("–°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"); }
}

async function loadRoadFromServer(file) {
    if (!file) return;
    try {
        currentRoadFolder = 'roads/' + file.replace('.json', '');
        const res = await fetch(getNoCacheUrl('roads/' + file));
        processJSON(await res.json());
    } catch(e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞"); }
}

function loadLocalJSON(e) {
    if (!e.target.files.length) return;
    const file = e.target.files[0];
    currentRoadFolder = 'roads/' + file.name.replace('.json', '');
    const r = new FileReader();
    r.onload = () => { try { processJSON(JSON.parse(r.result)); } catch(e) { alert("–û—à–∏–±–∫–∞ JSON"); } };
    r.readAsText(file);
}

function processJSON(data) {
    points = data.map(p => ({ 
        id: p.id, 
        coords: [parseFloat(p.lat), parseFloat(p.lon)], 
        azimuth: parseInt(p.azimuth) || 0, 
        text: p.command || '', 
        comment: p.comment || '',
        color: p.color || 'Gold',
        freePath: p.freePath || [] 
    }));
    currentIndex = 0; 
    preloadAudio();
    rebuildRoute();
    if(points.length > 0 && map) map.setCenter(points[0].coords, 18);
}

async function preloadAudio() {
    const bar = document.getElementById('audioProgressBar');
    const container = document.getElementById('audioProgress');
    container.style.display = 'block'; bar.style.width = '0%';
    
    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
    Object.values(audioCache).forEach(url => URL.revokeObjectURL(url));
    audioCache = {}; audioStatus = {};
    
    let loaded = 0;
    for (const p of points) {
        try {
            const response = await fetch(getNoCacheUrl(`${currentRoadFolder}/${p.id}.mp3`));
            if (response.ok) {
                const blob = await response.blob();
                audioCache[p.id] = URL.createObjectURL(blob);
                audioStatus[p.id] = true;
            } else audioStatus[p.id] = false;
        } catch (e) { audioStatus[p.id] = false; } 
        loaded++;
        bar.style.width = (loaded / points.length * 100) + '%';
        if (loaded % 3 === 0 || loaded === points.length) rebuildRoute();
    }
    setTimeout(() => container.style.display = 'none', 1000);
}

function playAudio(id) { 
    if (audioCache[id]) {
        const a = new Audio(audioCache[id]);
        a.play().catch(e => console.error(e));
    }
}

function initMap(){
    map = new ymaps.Map("map", { center:[56.33, 43.93], zoom:18, type:'yandex#satellite', controls:[] });
    userPlacemark = new ymaps.Placemark([0,0],{},{ 
        iconLayout:'default#image', iconImageHref: getIcon(0, 'red', false, ''), iconImageSize:[40,40], iconImageOffset:[-20,-20] 
    });
    map.geoObjects.add(userPlacemark);
    navigator.geolocation.watchPosition(onGPS, null, {enableHighAccuracy:true, maximumAge:0, timeout:5000});
}

function onGPS(p){
    const c = [p.coords.latitude, p.coords.longitude];
    const speed = p.coords.speed ? (p.coords.speed * 3.6).toFixed(1) : 0;
    
    if (p.coords.heading !== null && p.coords.speed > 0.8) {
        azHistory.push(p.coords.heading);
        if (azHistory.length > 4) azHistory.shift();
        lastAzimuth = averageAngle(azHistory);
    }
    
    userPlacemark.geometry.setCoordinates(c);
    userPlacemark.options.set('iconImageHref', getIcon(lastAzimuth, 'red', false, ''));
    if (autoCenter) map.setCenter(c);
    checkDistance(c, speed, lastAzimuth);
}

function averageAngle(arr){
    let x=0, y=0;
    for (const a of arr){ let r=a*Math.PI/180; x+=Math.cos(r); y+=Math.sin(r); }
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function rebuildRoute() {
    if(!map) return;
    // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã –∫—Ä–æ–º–µ –º–µ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const toRemove = [];
    map.geoObjects.each(o => { if(o !== userPlacemark) toRemove.push(o); });
    toRemove.forEach(o => map.geoObjects.remove(o));
    
    const list = document.getElementById('targets'); list.innerHTML = '';
    
    points.forEach((p, i) => {
        const active = i === currentIndex, passed = i < currentIndex, op = passed ? 0.3 : 1;
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–Ω–∏–π –ø—É—Ç–∏ (freePath)
        if (p.freePath && p.freePath.length > 1) {
            map.geoObjects.add(new ymaps.Polyline(p.freePath, {}, {
                strokeColor: COLOR_MAP[p.color] || '#FFD700',
                strokeWidth: active ? 5 : 3, strokeOpacity: active ? 0.9 : 0.4
            }));
        }

        // –ú–µ—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
        const pm = new ymaps.Placemark(p.coords, { 
            iconContent: (showLabels && !passed) ? (p.text || p.id) : "" 
        }, { 
            iconLayout:'default#imageWithContent', 
            iconImageHref: getIcon(p.azimuth, p.color, active, p.id, op), 
            iconImageSize:[40,40], iconImageOffset:[-20,-20], iconContentOffset: [35, -10],
            iconContentLayout: ymaps.templateLayoutFactory.createClass('{% if properties.iconContent %}<div class="cmd-bubble">$[properties.iconContent]</div>{% endif %}')
        });
        map.geoObjects.add(pm);

        // –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞
        const d = document.createElement('div');
        d.className = `target-item ${active ? 'active' : ''} ${passed ? 'passed' : ''}`;
        
        let audioIcon = '‚è≥'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∑–∫–∞
        if (audioStatus[p.id] === true) audioIcon = 'üîä';
        else if (audioStatus[p.id] === false) audioIcon = (p.text ? 'ü§ñ' : '‚ö™');
        
        d.innerHTML = `
            <div class="target-main">
                <i class="audio-icon" onclick="event.stopPropagation(); playAudio('${p.id}')">${audioIcon}</i>
                <div class="target-content">
                    ${p.id}. ${p.text || '–¢–æ—á–∫–∞'}
                </div>
                ${p.comment ? `<button class="comment-toggle" onclick="event.stopPropagation(); toggleCommentDisplay(this)">üìù</button>` : ''}
            </div>
            ${p.comment ? `<div class="target-comment">${p.comment}</div>` : ''}
        `;
        
        d.onclick = () => { currentIndex = i; rebuildRoute(); };
        list.appendChild(d);
    });
}

function toggleCommentDisplay(btn) {
    const commentDiv = btn.parentElement.nextElementSibling;
    const isVisible = commentDiv.classList.toggle('visible');
    btn.style.background = isVisible ? '#2f80ed' : '#eee';
    btn.style.color = isVisible ? '#fff' : '#000';
}

function checkDistance(pos, speed, az){
    if (currentIndex >= points.length) return;
    const p = points[currentIndex];
    const dist = Math.round(getDistance(pos[0], pos[1], p.coords[0], p.coords[1]));
    const currentAz = Math.round(az);
    const diff = Math.abs(((currentAz - p.azimuth + 540) % 360) - 180);
    
    document.getElementById('info').innerHTML = `
        ‚Ññ${p.id} | ${p.text || (p.comment ? '['+p.comment+']' : '---')}<br>
        –î–∏—Å—Ç: ${dist}–º | –¶–µ–ª—å: ${p.azimuth}¬∞ | –ö—É—Ä—Å: ${currentAz}¬∞ | ${speed} –∫–º/—á
    `;

    if (dist <= (+document.getElementById('distanceTrigger').value || 20) && diff <= 45) {
        speechSynthesis.cancel();
        if (audioCache[p.id]) {
            playAudio(p.id);
        } else if (p.text) {
            speechSynthesis.speak(new SpeechSynthesisUtterance(p.text));
        }
        currentIndex++; 
        rebuildRoute();
    }
}

function getIcon(az, col, sel, id, op = 1) {
    const fill = col || 'Gold';
    const inner = id ? `<circle cx="20" cy="20" r="9" fill="white" fill-opacity="${op}" stroke="${fill}" stroke-width="2"/><text x="20" y="24" font-size="11" font-family="Arial" font-weight="900" text-anchor="middle" opacity="${op}">${id}</text>` : '';
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${az},20,20)" opacity="${op}"><polygon points="20,2 35,35 20,26 5,35" fill="${fill}" stroke="${sel?'#2ecc71':'#000'}" stroke-width="${sel?3:1.5}"/></g>${inner}</svg>`);
}

function getDistance(a,b,c,d){
    const R=6371000, rLat=(c-a)*Math.PI/180, rLon=(d-b)*Math.PI/180;
    const x=Math.sin(rLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(rLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function togglePanelUI() { document.getElementById('panel').classList.toggle('collapsed'); }
function toggleCenter() { autoCenter = !autoCenter; document.getElementById('toggleAutoCenter').textContent = '–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: '+(autoCenter?'–í–∫–ª':'–í—ã–∫–ª'); }
function toggleLabels() { 
    showLabels = !showLabels; 
    document.getElementById('toggleLabelsBtn').style.background = showLabels ? '#27ae60' : '#2f80ed';
    rebuildRoute(); 
}
</script>
</body>
</html>
