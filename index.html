<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>GPS –ù–∞–≤–∏–≥–∞—Ç–æ—Ä</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU"></script>

    <style>
        body, html { margin: 0; height: 100%; font-family: 'Inter', Arial, sans-serif; overflow: hidden; background: #000; }
        #map { position: absolute; inset: 0; }
        #start {
            position: absolute; inset: 0; z-index: 2000; background: #1a1a1a; color: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 22px; cursor: pointer;
        }
        #panel { 
            position: absolute; top: 10px; right: 10px; width: 300px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: none;
        }
        #panel.collapsed { transform: translateY(-150%); opacity: 0; pointer-events: none; }
        #togglePanel {
            position: absolute; bottom: 85px; right: 20px; z-index: 1001;
            width: 50px; height: 50px; border-radius: 25px; border: none;
            background: #2f80ed; color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center;
        }
        #info {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95); padding: 12px;
            font-weight: bold; font-size: 14px; z-index: 15;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 1px solid #ddd;
            min-height: 45px; box-sizing: border-box;
        }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        select, input { 
            flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; 
            font-family: inherit; font-size: 14px; background: white;
        }
        button { 
            cursor: pointer; border: none; border-radius: 8px; padding: 10px; 
            background: #2f80ed; color: white; font-weight: bold; font-family: inherit;
            display: flex; align-items: center; justify-content: center;
        }
        button.secondary { background: #6c757d; }
        #targets { max-height: 180px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #eee; }
        #targets div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
        #targets div.active { background: #e3f2fd; font-weight: bold; border-left: 4px solid #2f80ed; }
        #targets div.passed { color: #aaa; text-decoration: line-through; }
        .cmd-bubble {
            background: white; border: 2px solid #333; border-radius: 6px;
            padding: 4px 8px; font-size: 12px; font-weight: bold; color: #000;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3); display: inline-block;
        }
    </style>
</head>

<body>

<div id="start">
    <div>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞</div>
    <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ GPS –∏ –∑–≤—É–∫—É</div>
</div>

<button id="togglePanel" onclick="togglePanelUI()">‚â°</button>

<div id="panel">
    <div class="row">
        <select id="routeSelect">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
        </select>
        <button class="secondary" onclick="toggleLabels()" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–ø–∏—Å–∏">üëÅÔ∏è</button>
    </div>
    
    <div style="margin-top:10px;">
        <label style="font-size:11px; font-weight:bold; color: #666;">–î–ò–°–¢–ê–ù–¶–ò–Ø –¢–†–ò–ì–ì–ï–†–ê (–ú)</label>
        <input id="distanceTrigger" type="number" value="20">
    </div>

    <div class="row" style="margin-top:10px;">
        <button id="toggleAutoCenter" style="width: 100%;" onclick="toggleCenter()">–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: –í–∫–ª</button>
    </div>
    
    <div id="targets"></div>
</div>

<div id="info">–û–∂–∏–¥–∞–Ω–∏–µ GPS‚Ä¶</div>
<div id="map"></div>

<script>
let map, userPlacemark, points = [], currentIndex = 0, autoCenter = true, showLabels = false, wakeLock = null;
let azHistory = [], lastAzimuth = 0, lastSpeed = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ
document.getElementById('start').onclick = async () => {
    document.getElementById('start').remove();
    document.getElementById('panel').style.display = 'block';
    document.getElementById('togglePanel').style.display = 'flex';
    
    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞—É–¥–∏–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è iOS/Chrome
    speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    
    if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
    initMap();
    loadRouteList();
};

function togglePanelUI() { document.getElementById('panel').classList.toggle('collapsed'); }

function toggleCenter() {
    autoCenter = !autoCenter;
    document.getElementById('toggleAutoCenter').textContent = `–ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä: ${autoCenter ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
}

function toggleLabels() {
    showLabels = !showLabels;
    rebuildRoute();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏–∑ roads/list.json
async function loadRouteList() {
    const select = document.getElementById('routeSelect');
    try {
        const response = await fetch('roads/list.json');
        if (!response.ok) throw new Error();
        const routes = await response.json();
        
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</option>';
        routes.forEach(r => {
            const opt = document.createElement('option');
            opt.value = `roads/${r.file}`;
            opt.textContent = r.name;
            select.appendChild(opt);
        });

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç, –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
        const lastRoute = localStorage.getItem('lastRoute');
        if (lastRoute) {
            select.value = lastRoute;
            loadRouteData(lastRoute);
        }
    } catch (e) {
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞</option>';
    }
}

// –°–ª—É—à–∞—Ç–µ–ª—å –≤—ã–±–æ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞
document.getElementById('routeSelect').onchange = (e) => {
    if (e.target.value) {
        loadRouteData(e.target.value);
        localStorage.setItem('lastRoute', e.target.value);
    }
};

async function loadRouteData(url) {
    try {
        const response = await fetch(url);
        const data = await response.json();
        points = data.map(p => ({
            id: p.id,
            coords: [parseFloat(p.lat), parseFloat(p.lon)],
            azimuth: p.azimuth,
            text: p.command || '',
            color: p.color || 'Gold'
        }));
        currentIndex = 0;
        rebuildRoute();
        if (points.length) map.setCenter(points[0].coords, 17);
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∞");
    }
}

function initMap(){
    ymaps.ready(() => {
        map = new ymaps.Map("map", { 
            center: [0,0], zoom: 18, 
            type: 'yandex#satellite', 
            controls: [] 
        });
        
        userPlacemark = new ymaps.Placemark([0,0], {}, {
            iconLayout: 'default#image',
            iconImageHref: getIcon(0, 'red', false, '', 1),
            iconImageSize: [40, 40], iconImageOffset: [-20, -20]
        });
        
        map.geoObjects.add(userPlacemark);
        navigator.geolocation.watchPosition(onGPS, null, {enableHighAccuracy:true, maximumAge:0});
    });
}

function onGPS(p){
    const c = [p.coords.latitude, p.coords.longitude];
    const speedKmh = p.coords.speed != null ? p.coords.speed * 3.6 : 0;
    lastSpeed = speedKmh.toFixed(1);

    if (p.coords.heading !== null && !isNaN(p.coords.heading) && speedKmh >= 3) {
        azHistory.push(p.coords.heading);
        if (azHistory.length > 3) azHistory.shift();
    }
    
    const avgAz = azHistory.length ? averageAngle(azHistory) : lastAzimuth;
    lastAzimuth = avgAz;

    userPlacemark.geometry.setCoordinates(c);
    userPlacemark.options.set('iconImageHref', getIcon(avgAz, 'red', false, '', 1));
    
    if (autoCenter) map.setCenter(c);
    checkDistance(c, lastSpeed, avgAz);
}

function averageAngle(arr){
    let x=0, y=0;
    for (const a of arr){
        const r=a*Math.PI/180;
        x+=Math.cos(r); y+=Math.sin(r);
    }
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function getIcon(azimuth, colorName, isSelected, id, opacity = 1) {
    const fill = colorName || 'Gold';
    const stroke = isSelected ? '#2ecc71' : '#000';
    const inner = id ? `<circle cx="20" cy="20" r="9" fill="white" opacity="${opacity}" stroke="${fill}" stroke-width="2"/><text x="20" y="24" font-size="11" font-family="Arial" font-weight="900" text-anchor="middle" opacity="${opacity}">${id}</text>` : '';
    
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><g transform="rotate(${azimuth},20,20)" opacity="${opacity}"><polygon points="20,2 35,35 20,26 5,35" fill="${fill}" stroke="${stroke}" stroke-width="${isSelected?3:1.5}"/></g>${inner}</svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function checkDistance(pos, speed, az){
    if (currentIndex >= points.length) return;
    
    const p = points[currentIndex];
    const dist = Math.round(getDistance(pos[0], pos[1], p.coords[0], p.coords[1]));
    const diff = Math.abs(((Math.round(az) - p.azimuth + 540) % 360) - 180);
    
    document.getElementById('info').innerHTML = 
        `‚Ññ${p.id} | ${p.text}<br>–î–∏—Å—Ç: ${dist}–º | –¶–µ–ª—å: ${p.azimuth}¬∞ | –ö—É—Ä—Å: ${Math.round(az)}¬∞ | ${speed} –∫–º/—á`;

    if (dist <= (+document.getElementById('distanceTrigger').value || 20) && diff <= 45) {
        announceCommand(p);
        currentIndex++;
        rebuildRoute();
    }
}

function announceCommand(p) {
    const audio = new Audio(`voice/${p.id}.mp3`);
    audio.play().catch(() => {
        const utterance = new SpeechSynthesisUtterance(p.text);
        utterance.lang = 'ru-RU';
        speechSynthesis.speak(utterance);
    });
}

function rebuildRoute() {
    clearRoute();
    const list = document.getElementById('targets');
    list.innerHTML = '';

    points.forEach((p, i) => {
        const isActive = i === currentIndex;
        const isPassed = i < currentIndex;
        const opacity = isPassed ? 0.3 : 1;

        p.placemark = new ymaps.Placemark(p.coords, 
            { iconContent: (showLabels && !isPassed) ? p.text : "" },
            { 
                iconLayout: 'default#imageWithContent',
                iconImageHref: getIcon(p.azimuth, p.color, isActive, p.id, opacity),
                iconImageSize: [40, 40], iconImageOffset: [-20, -20],
                iconContentLayout: ymaps.templateLayoutFactory.createClass(
                    '{% if properties.iconContent %}<div class="cmd-bubble">$[properties.iconContent]</div>{% endif %}'
                )
            }
        );
        
        map.geoObjects.add(p.placemark);
        
        const d = document.createElement('div');
        d.textContent = `${p.id}. ${p.text}`;
        if(isActive) { d.classList.add('active'); d.scrollIntoView({behavior:'smooth', block:'center'}); }
        if(isPassed) d.classList.add('passed');
        d.onclick = () => { currentIndex = i; rebuildRoute(); };
        list.appendChild(d);
    });
}

function clearRoute() {
    if(!map) return;
    const toRemove = [];
    map.geoObjects.each(o => { if(o !== userPlacemark) toRemove.push(o); });
    toRemove.forEach(o => map.geoObjects.remove(o));
}

function getDistance(a,b,c,d){
    const R=6371000;
    const dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180;
    const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>
</body>
</html>
