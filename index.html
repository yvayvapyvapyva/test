<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Навигатор с голосовыми командами</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            min-height: 100px;
        }
        .point-info {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #4CAF50;
            background-color: #f9f9f9;
        }
        .active {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        .completed {
            border-left-color: #2196F3;
            background-color: #e3f2fd;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .voice-controls {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 200px;
        }
        .voice-test {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        label {
            font-weight: bold;
            margin-right: 10px;
        }
        .voice-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Навигатор с голосовыми командами</h1>
        
        <div class="voice-controls">
            <h3>Настройки голоса:</h3>
            <div class="voice-test">
                <label for="voiceSelect">Выберите голос:</label>
                <select id="voiceSelect">
                    <option value="">Загрузка голосов...</option>
                </select>
                <button id="refreshVoicesBtn">Обновить голоса</button>
            </div>
            <div class="voice-test">
                <label>Тест голоса:</label>
                <input type="text" id="testText" value="Тестовое сообщение для проверки голоса" style="flex-grow: 1; padding: 8px;">
                <button id="testVoiceBtn">Произнести</button>
            </div>
            <div class="voice-preview" id="voiceInfo">
                Информация о голосе появится после загрузки
            </div>
        </div>
        
        <div>
            <h3>Введите точки в формате:</h3>
            <p>широта,долгота,команда (каждая точка с новой строки)</p>
            <textarea id="pointsInput" placeholder="Пример:
55.7558,37.6173,Поверните направо
55.7565,37.6180,Идите прямо 50 метров
55.7570,37.6190,Ваш пункт назначения слева"></textarea>
        </div>
        
        <div class="controls">
            <button id="startBtn">Начать навигацию</button>
            <button id="stopBtn" disabled>Остановить</button>
            <button id="getLocationBtn">Получить текущее местоположение</button>
        </div>
        
        <div class="status" id="status">
            Статус: Ожидание начала навигации
        </div>
        
        <div id="pointsList"></div>
    </div>

    <script>
        let watchId = null;
        let points = [];
        let currentPointIndex = 0;
        let isNavigating = false;
        let speechSynthesis = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;

        // Элементы DOM
        const pointsInput = document.getElementById('pointsInput');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const statusDiv = document.getElementById('status');
        const pointsListDiv = document.getElementById('pointsList');
        const voiceSelect = document.getElementById('voiceSelect');
        const testVoiceBtn = document.getElementById('testVoiceBtn');
        const refreshVoicesBtn = document.getElementById('refreshVoicesBtn');
        const testText = document.getElementById('testText');
        const voiceInfo = document.getElementById('voiceInfo');

        // Пример точек по умолчанию
        pointsInput.value = `55.7520,37.6175,Идите к Спасской башне
55.7530,37.6190,Поверните налево к собору
55.7540,37.6200,Подойдите к Царь-пушке
55.7550,37.6210,Вы у цели - Успенский собор`;

        // Загрузка доступных голосов
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '<option value="">Выберите голос...</option>';
            
            // Фильтруем русские голоса и мужские голоса
            const russianVoices = voices.filter(voice => 
                voice.lang.startsWith('ru') || 
                voice.lang.startsWith('ru-RU') ||
                voice.name.toLowerCase().includes('russian')
            );
            
            // Сначала показываем мужские голоса
            const maleVoices = russianVoices.filter(voice => 
                voice.name.toLowerCase().includes('male') ||
                voice.name.toLowerCase().includes('мужск') ||
                voice.name.toLowerCase().includes('michael') ||
                voice.name.toLowerCase().includes('alex') ||
                voice.name.toLowerCase().includes('maxim')
            );
            
            const otherVoices = russianVoices.filter(voice => 
                !maleVoices.includes(voice)
            );
            
            // Добавляем мужские голоса
            if (maleVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Мужские голоса';
                maleVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.name.toLowerCase().includes('male') || 
                        voice.name.toLowerCase().includes('мужск')) {
                        option.selected = true;
                        selectedVoice = voice;
                    }
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
            
            // Добавляем остальные голоса
            if (otherVoices.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'Другие голоса';
                otherVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
            
            // Если есть мужские голоса, выбираем первый по умолчанию
            if (maleVoices.length > 0 && !selectedVoice) {
                selectedVoice = maleVoices[0];
                voiceSelect.value = selectedVoice.name;
            }
            
            updateVoiceInfo();
        }

        // Обновление информации о выбранном голосе
        function updateVoiceInfo() {
            if (selectedVoice) {
                voiceInfo.innerHTML = `
                    <strong>Текущий голос:</strong> ${selectedVoice.name}<br>
                    <strong>Язык:</strong> ${selectedVoice.lang}<br>
                    <strong>Пол:</strong> ${selectedVoice.name.toLowerCase().includes('male') || 
                                          selectedVoice.name.toLowerCase().includes('мужск') ? 
                                          'Мужской' : 'Не указан'}
                `;
            } else {
                voiceInfo.innerHTML = 'Голос не выбран';
            }
        }

        // Тест голоса
        testVoiceBtn.addEventListener('click', () => {
            speak(testText.value, true);
        });

        // Обновить список голосов
        refreshVoicesBtn.addEventListener('click', () => {
            loadVoices();
        });

        // Изменение выбранного голоса
        voiceSelect.addEventListener('change', (e) => {
            const voiceName = e.target.value;
            selectedVoice = voices.find(voice => voice.name === voiceName);
            updateVoiceInfo();
            
            // Произнести тестовое сообщение при смене голоса
            if (selectedVoice) {
                setTimeout(() => speak('Голос изменён', true), 100);
            }
        });

        // Получить текущее местоположение
        getLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        statusDiv.innerHTML = `Текущее местоположение:<br>
                        Широта: ${lat.toFixed(6)}<br>
                        Долгота: ${lng.toFixed(6)}<br>
                        Точность: ${position.coords.accuracy} метров`;
                    },
                    (error) => {
                        statusDiv.innerHTML = `Ошибка получения геолокации: ${error.message}`;
                    }
                );
            } else {
                statusDiv.innerHTML = 'Геолокация не поддерживается вашим браузером';
            }
        });

        // Начать навигацию
        startBtn.addEventListener('click', () => {
            parsePoints();
            if (points.length === 0) {
                statusDiv.innerHTML = 'Ошибка: нет точек для навигации';
                return;
            }

            isNavigating = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            currentPointIndex = 0;
            
            updatePointsList();
            statusDiv.innerHTML = `Навигация начата. Всего точек: ${points.length}<br>
            Текущая точка: ${points[0].command}`;

            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    handlePositionUpdate,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 27000
                    }
                );
            } else {
                statusDiv.innerHTML = 'Геолокация не поддерживается вашим браузером';
                stopNavigation();
            }
        });

        // Остановить навигацию
        stopBtn.addEventListener('click', stopNavigation);

        // Парсинг точек
        function parsePoints() {
            points = [];
            const lines = pointsInput.value.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    const parts = line.split(',');
                    if (parts.length >= 3) {
                        const lat = parseFloat(parts[0]);
                        const lng = parseFloat(parts[1]);
                        const command = parts.slice(2).join(',').trim();
                        
                        if (!isNaN(lat) && !isNaN(lng) && command) {
                            points.push({
                                lat: lat,
                                lng: lng,
                                command: command,
                                completed: false
                            });
                        }
                    }
                }
            });
        }

        // Обновление списка точек
        function updatePointsList() {
            pointsListDiv.innerHTML = '<h3>Маршрут:</h3>';
            points.forEach((point, index) => {
                const div = document.createElement('div');
                div.className = 'point-info';
                
                if (index === currentPointIndex && isNavigating) {
                    div.classList.add('active');
                } else if (point.completed) {
                    div.classList.add('completed');
                }
                
                div.innerHTML = `
                    <strong>Точка ${index + 1}:</strong><br>
                    Координаты: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}<br>
                    Команда: ${point.command}<br>
                    Статус: ${point.completed ? 'Выполнено' : (index === currentPointIndex ? 'Активная' : 'В ожидании')}
                `;
                
                pointsListDiv.appendChild(div);
            });
        }

        // Обработка обновления позиции
        function handlePositionUpdate(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            
            if (currentPointIndex >= points.length) {
                speak('Вы достигли конечной точки маршрута!', false);
                statusDiv.innerHTML = 'Маршрут завершен! Все точки пройдены.';
                stopNavigation();
                return;
            }

            const currentPoint = points[currentPointIndex];
            const distance = calculateDistance(
                userLat, userLng,
                currentPoint.lat, currentPoint.lng
            );

            statusDiv.innerHTML = `
                Текущее местоположение:<br>
                Широта: ${userLat.toFixed(6)}<br>
                Долгота: ${userLng.toFixed(6)}<br>
                Точность: ${position.coords.accuracy.toFixed(1)} метров<br><br>
                Текущая точка ${currentPointIndex + 1}/${points.length}:<br>
                ${currentPoint.command}<br>
                Расстояние до точки: ${distance.toFixed(1)} метров
            `;

            if (distance <= 20) {
                speak(currentPoint.command, false);
                currentPoint.completed = true;
                
                currentPointIndex++;
                
                if (currentPointIndex < points.length) {
                    setTimeout(() => {
                        speak(`Следующая точка: ${points[currentPointIndex].command}`, false);
                    }, 2000);
                }
                
                updatePointsList();
            }
        }

        // Обработка ошибок геолокации
        function handleLocationError(error) {
            let message = 'Ошибка геолокации: ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Пользователь отказал в доступе к геолокации';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Информация о местоположении недоступна';
                    break;
                case error.TIMEOUT:
                    message += 'Время запроса геолокации истекло';
                    break;
                default:
                    message += 'Неизвестная ошибка';
                    break;
            }
            
            statusDiv.innerHTML = message;
            stopNavigation();
        }

        // Остановка навигации
        function stopNavigation() {
            isNavigating = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            statusDiv.innerHTML = 'Навигация остановлена';
        }

        // Функция для озвучивания текста
        function speak(text, isTest = false) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            utterance.rate = 1.0;
            utterance.pitch = isTest ? 0.8 : 1.0; // Немного ниже для мужского голоса
            utterance.volume = 1.0;
            
            // Используем выбранный голос, если доступен
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            speechSynthesis.speak(utterance);
            
            // Логирование для отладки
            if (isTest) {
                console.log('Тест голоса:', {
                    текст: text,
                    голос: selectedVoice ? selectedVoice.name : 'по умолчанию',
                    язык: utterance.lang,
                    pitch: utterance.pitch
                });
            }
        }

        // Расчет расстояния
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Инициализация
        window.speechSynthesis.onvoiceschanged = loadVoices;
        
        // Первоначальная загрузка голосов
        setTimeout(loadVoices, 1000);
        
        parsePoints();
        updatePointsList();
        
        // Предупреждение о необходимости HTTPS
        if (location.protocol !== 'https:') {
            statusDiv.innerHTML = 'Внимание: Для работы геолокации рекомендуется использовать HTTPS соединение.';
        }
    </script>
</body>
</html>
